<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Clothing Retail ‚Äì Multi-Store Manager</title>
<style>
  :root{
    --bg:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --bg-solid:#f5f7fa;
    --panel:#ffffff;--panel-2:#f8fafc;--muted:#64748b;
    --text:#1e293b;--accent:#6366f1;--accent-2:#10b981;--warn:#f59e0b;--danger:#ef4444;
    --chip:#e0e7ff;--border:#e2e8f0;
    --good:#10b981;--bad:#ef4444;
    --shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
    --shadow-lg:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);
    --radius:12px;
    --gradient-primary:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-success:linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-danger:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }
  [data-theme="dark"]{
    --bg:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    --bg-solid:#0f172a;
    --panel:#1e293b;--panel-2:#334155;--muted:#94a3b8;
    --text:#f1f5f9;--accent:#818cf8;--accent-2:#34d399;--warn:#fbbf24;--danger:#f87171;
    --chip:#334155;--border:#475569;
    --shadow:0 4px 6px -1px rgba(0,0,0,.3),0 2px 4px -1px rgba(0,0,0,.2);
    --shadow-lg:0 20px 25px -5px rgba(0,0,0,.3),0 10px 10px -5px rgba(0,0,0,.2);
    --gradient-primary:linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
    --gradient-success:linear-gradient(135deg, #34d399 0%, #10b981 100%);
    --gradient-danger:linear-gradient(135deg, #f87171 0%, #ef4444 100%);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{margin:0;font:16px/1.5 "Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;color:var(--text);background:var(--bg-solid);position:relative}
  body::before{content:'';position:fixed;top:0;left:0;right:0;height:400px;background:var(--bg);z-index:-1}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);box-shadow:var(--shadow);border-bottom:1px solid var(--border)}
  [data-theme="dark"] header{background:rgba(30,41,59,0.95)}
  .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;max-width:1400px;margin:0 auto;flex-wrap:wrap}
  @media (max-width: 768px) {
    .bar {
      flex-direction: column;
      align-items: stretch;
      gap:16px;
    }
    .tabs{
      width:100%;
      justify-content:flex-start;
    }
    .toolbar{
      width:100%;
      justify-content:space-between;
    }
  }
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:12px;background:var(--gradient-primary);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:white;box-shadow:0 4px 6px -1px rgba(102,126,234,0.4);transition:transform .2s}
  .logo:hover{transform:scale(1.05)}
  .brand h1{font-size:22px;margin:0;font-weight:700;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  @media (max-width: 480px) {
    .logo{width:40px;height:40px;font-size:20px}
    .brand h1{font-size:18px}
    .brand .chip{display:none}
  }
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 18px;border:none;background:transparent;color:var(--muted);border-radius:var(--radius);cursor:pointer;transition:all .3s ease;font-weight:500;position:relative}
  @media (max-width: 768px) {
    .tab{padding:8px 12px;font-size:14px}
  }
  @media (max-width: 480px) {
    .tabs{gap:4px}
    .tab{padding:6px 10px;font-size:12px;white-space:nowrap}
  }
  .tab:hover{background:var(--chip);color:var(--text);transform:translateY(-2px)}
  .tab.active{background:var(--gradient-primary);color:white;box-shadow:var(--shadow);transform:translateY(-2px)}
  .tab.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:3px;background:white;border-radius:3px 3px 0 0}
  .container{max-width:1400px;margin:24px auto;padding:0 24px 48px}
  @media (max-width: 768px) {
    .container{padding:0 16px 32px;margin:16px auto}
  }
  @media (max-width: 480px) {
    .container{padding:0 12px 24px;margin:12px auto}
  }
  .grid{display:grid;grid-template-columns:300px 1fr;gap:24px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  @media (max-width: 768px) {
    .grid{gap:16px}
  }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);transition:transform .3s,box-shadow .3s;overflow:hidden}
  .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg)}
  @media (max-width: 768px) {
    .card{border-radius:8px}
    .card:hover{transform:translateY(-2px)}
  }
  @media (max-width: 480px) {
    .card{border-radius:6px}
  }
  .card h3{margin:0;padding:20px;border-bottom:2px solid var(--border);font-size:18px;font-weight:700;background:linear-gradient(to right,var(--panel-2),var(--panel));position:relative}
  .card h3::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--gradient-primary)}
  .section{padding:16px}
  @media (max-width: 640px) {
    .section{padding:12px}
  }
  .stack{display:flex;flex-direction:column;gap:16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  @media (max-width: 640px) {
    .row{gap:12px}
    .row > *{flex:1 1 100%;min-width:0}
  }
  input,select,button,textarea{font:inherit;transition:all .2s}
  .input,.select{flex:1;min-width:180px;background:var(--panel);border:2px solid var(--border);color:var(--text);padding:12px 16px;border-radius:var(--radius);outline:0;transition:all .3s ease;font-weight:500}
  @media (max-width: 640px) {
    .input,.select{min-width:100%;padding:10px 12px;font-size:16px}
  }
  .input:focus,.select:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(99,102,241,.1);transform:translateY(-1px)}
  .input:hover,.select:hover{border-color:var(--muted)}
  .btn{background:var(--gradient-primary);border:none;color:white;padding:12px 24px;border-radius:var(--radius);cursor:pointer;font-weight:600;transition:all .3s ease;box-shadow:0 4px 6px -1px rgba(102,126,234,0.3);position:relative;overflow:hidden}
  @media (max-width: 640px) {
    .btn{padding:10px 16px;font-size:14px}
  }
  @media (max-width: 480px) {
    .btn{padding:8px 12px;font-size:13px}
  }
  .btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,0.3);transform:translate(-50%,-50%);transition:width .6s,height .6s}
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 15px -3px rgba(102,126,234,0.4)}
  .btn:hover::before{width:300px;height:300px}
  .btn:active{transform:translateY(0)}
  .btn.secondary{background:var(--muted);box-shadow:0 4px 6px -1px rgba(100,116,139,0.3)}
  .btn.green{background:var(--gradient-success);box-shadow:0 4px 6px -1px rgba(16,185,129,0.3)}
  .btn.warn{background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:white;box-shadow:0 4px 6px -1px rgba(251,191,36,0.3)}
  .btn.red{background:var(--gradient-danger);box-shadow:0 4px 6px -1px rgba(239,68,68,0.3)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  @media (max-width: 640px) {
    .toolbar{gap:6px}
  }
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:8px 16px;border-radius:20px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-weight:600;font-size:13px;transition:all .2s}
  .chip:hover{transform:scale(1.05);box-shadow:var(--shadow)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px 16px;border-bottom:1px solid var(--border)}
  @media (max-width: 768px) {
    th,td{padding:10px 12px;font-size:14px}
  }
  @media (max-width: 480px) {
    th,td{padding:8px;font-size:13px}
  }
  th{color:var(--muted);text-align:left;background:var(--panel-2);font-weight:600;position:sticky;top:0}
  tbody tr{transition:all .2s ease}
  tbody tr:hover{background:var(--panel-2);transform:scale(1.01);box-shadow:0 2px 4px rgba(0,0,0,0.05)}
  .muted{color:var(--muted)}
  .right{text-align:right}
  .mono{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .badge{padding:6px 12px;border-radius:20px;border:none;background:var(--gradient-primary);color:white;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 4px rgba(102,126,234,0.3)}
  .status{padding:4px 12px;border-radius:20px;font-weight:700;font-size:12px;display:inline-block}
  .status.ok{background:rgba(16,185,129,0.1);color:var(--good)}
  .status.low{background:rgba(251,191,36,0.1);color:var(--warn)}
  .status.out{background:rgba(239,68,68,0.1);color:var(--danger)}
  .split{display:grid;grid-template-columns:1fr 460px;gap:24px}
  @media (max-width:1100px){.split{grid-template-columns:1fr}}
  @media (max-width: 768px) {
    .split{gap:16px}
  }
  .totals{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width: 640px) {
    .totals{grid-template-columns:1fr;gap:10px}
  }
  .totals .kpi{background:var(--panel-2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:all .3s;position:relative;overflow:hidden}
  .totals .kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gradient-primary);opacity:0;transition:opacity .3s}
  .totals .kpi:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg)}
  .totals .kpi:hover::before{opacity:1}
  .kpi h4{margin:0 0 12px 0;font-size:13px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
  .kpi .val{font-size:28px;font-weight:700;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius);background:var(--chip)}
  .link{color:var(--accent);text-decoration:none;cursor:pointer}
  .link:hover{text-decoration:underline}
  .footer{margin-top:24px;color:var(--muted);font-size:14px;text-align:center}
  @media (max-width: 640px) {
    .footer{font-size:12px;padding:0 8px;line-height:1.6}
  }
  .table-container{overflow-x:auto}
  @media (max-width: 768px) {
    .table-container{
      -webkit-overflow-scrolling:touch;
      border-radius:var(--radius);
    }
    table{
      min-width:600px;
    }
  }
  .modal-backdrop{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.6)}
  .modal-content{background-color:var(--panel);color:var(--text);margin:10% auto;padding:24px;border:1px solid var(--border);width:80%;max-width:600px;border-radius:var(--radius);box-shadow:0 5px 15px rgba(0,0,0,0.5)}
  @media (max-width: 768px) {
    .modal-content{
      width:90%;
      margin:5% auto;
      padding:20px;
    }
  }
  @media (max-width: 480px) {
    .modal-content{
      width:95%;
      margin:2% auto;
      padding:16px;
      border-radius:8px;
    }
  }
  .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:16px}
  .modal-header h2{margin:0;font-size:22px}
  .modal-close{color:var(--muted);font-size:32px;font-weight:bold;cursor:pointer;transition:color .2s}
  .modal-close:hover,.modal-close:focus{color:var(--text);text-decoration:none}
  .modal-body{background-color:var(--bg);padding:16px;border-radius:4px;border:1px solid var(--border);overflow-x:auto;color:var(--text)}
  .modal-footer{display:flex;justify-content:flex-end;gap:12px;padding-top:16px;margin-top:16px;border-top:1px solid var(--border)}
  @media print {
    @page {
      size: A4;
      margin: 10mm;
    }
    body * {
      visibility: hidden;
    }
    #preview-content, #preview-content * {
      visibility: visible !important;
    }
    #preview-content {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
    .modal-backdrop {
      background: none !important;
      position: static !important;
    }
    .modal-content {
      box-shadow: none !important;
      border: none !important;
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
      max-width: 100% !important;
    }
    .modal-header, .modal-footer {
      display: none !important;
    }
  }
  
  /* Additional Mobile Optimizations */
  @media (max-width: 640px) {
    body{font-size:14px}
    .chip{padding:6px 12px;font-size:12px}
    .badge{padding:4px 10px;font-size:10px}
    .status{padding:3px 10px;font-size:11px}
    .kpi h4{font-size:12px}
    .kpi .val{font-size:24px}
  }
  
  /* Touch-friendly targets on mobile */
  @media (hover: none) and (pointer: coarse) {
    .btn, .tab, button{
      min-height:44px;
      min-width:44px;
    }
  }
  
  /* Landscape mobile optimization */
  @media (max-width: 960px) and (orientation: landscape) {
    .container{margin:12px auto;padding:0 16px 24px}
    header{position:relative}
  }
  
  /* Tablet-specific adjustments */
  @media (min-width: 641px) and (max-width: 1024px) {
    .grid{grid-template-columns:1fr}
    .split{grid-template-columns:1fr}
  }
  
  /* Toast notification animations */
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }

</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="firebase.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <div class="logo">C</div>
      <h1>Clothix ‚Äì Multi‚ÄëStore</h1>
      <span class="chip">GST-ready</span>
    </div>
    <div class="tabs" id="tabs"></div>
    <div class="toolbar">
      <div id="online-status" class="chip" style="display:flex;align-items:center;gap:6px;padding:6px 12px;">
        <span id="status-indicator" style="width:8px;height:8px;border-radius:50%;background:var(--good);"></span>
        <span id="status-text">Online</span>
      </div>
      <button class="btn" id="theme-toggle">üåô</button>
      <button class="btn secondary" id="exportBtn">Export</button>
      <button class="btn secondary" id="importBtn">Import</button>
      <button class="btn" id="demoBtn">Load Demo</button>
      <button class="btn red" id="resetBtn">Reset</button>
      <div id="user-controls" class="toolbar"></div>
    </div>
  </div>
</header>

<div class="container">
  <div id="view"></div>
  <div class="footer">Variant matrix (size/color), per‚Äëstore stock, transfers, and GST fields included. Use barcode/SKU lookup in POS. Data is stored locally in your browser. For e‚Äëinvoice/e‚Äëway bill, integrate with your chosen provider‚Äôs API server‚Äëside. [Info labels inspired by ecommerce templates.]</div>
</div>

<div id="print-modal" class="modal-backdrop">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Print Preview</h2>
      <span id="close-modal" class="modal-close">&times;</span>
    </div>
    <div id="preview-content" class="modal-body"></div>
    <div class="modal-footer">
      <button id="cancel-btn" class="btn secondary">Cancel</button>
      <button id="print-btn" class="btn green">Print</button>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
/* ====== Data Model (localStorage) ======
stores: [{id,name,code,address,phone}]
products: [{id,sku,style,name,brand,category,hsn,taxPct,sizes[],colors[],mrp,price,barcode,attributes,variants:[{size,color,sku,barcode}]}]
stock: [{storeId, productId, size, color, qty, min}]
customers: [{id,name,phone,gstin,address}]
invoices: [{id, date, time, storeId, number, customerId, items:[{productId,size,color,qty,price,taxPct,discount}], totals:{sub,tax,total,round}, payments:{mode,amount}, notes}]
transfers: [{id,date,fromStore,toStore,items:[{productId,size,color,qty}], note}]
purchases: [{id,date,storeId,ref,items:[{productId,size,color,qty,cost}], note}]
======================================== */
const DBKEY='clothix.db.v1';
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

// Offline mode variables (declare first!)
let isOnline = navigator.onLine;
let syncQueue = [];
let lastSyncTime = null;
const STORAGE_KEY = 'clothix_db';
const SYNC_QUEUE_KEY = 'clothix_sync_queue';
const LAST_SYNC_KEY = 'clothix_last_sync';

// Initialize offline mode
syncQueue = loadSyncQueue();
lastSyncTime = localStorage.getItem(LAST_SYNC_KEY);

// Load database (async)
let db = null;
let currentUser = null; // Tracks logged-in user with role

// Initialize app
(async function() {
  db = await load();
  
  // Update status on load
  updateOnlineStatus(isOnline, syncQueue.length === 0);
  
  // Initialize UI
  initApp();
})();

function initApp() {
  // Set up manual sync button  
  const statusEl = $('#online-status');
  if (statusEl) {
    statusEl.style.cursor = 'pointer';
    statusEl.onclick = async () => {
      if (!isOnline) {
        showNotification('Cannot sync while offline', 'warn');
        return;
      }
      if (syncQueue.length === 0) {
        showNotification('Everything is already synced', 'info');
        return;
      }
      await syncToFirebase();
    };
  }
}

function initDB() {
  return {
    stores: [],
    products: [],
    stock: [],
    customers: [],
    invoices: [],
    transfers: [],
    purchases: [],
    users: [],
    alerts: [],
    reorderSuggestions: [],
    cashReconciliation: [],
    seq: {inv:1,trn:1,pur:1}
  };
}

// Save to local storage (always)
function saveLocal() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    localStorage.setItem(LAST_SYNC_KEY, new Date().toISOString());
    return true;
  } catch (error) {
    console.error('Error saving to local storage:', error);
    return false;
  }
}

// Load from local storage
function loadLocal() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) {
      const parsed = JSON.parse(data);
      lastSyncTime = localStorage.getItem(LAST_SYNC_KEY);
      return parsed;
    }
    return null;
  } catch (error) {
    console.error('Error loading from local storage:', error);
    return null;
  }
}

// Save sync queue
function saveSyncQueue() {
  try {
    localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(syncQueue));
  } catch (error) {
    console.error('Error saving sync queue:', error);
  }
}

// Load sync queue
function loadSyncQueue() {
  try {
    const data = localStorage.getItem(SYNC_QUEUE_KEY);
    return data ? JSON.parse(data) : [];
  } catch (error) {
    console.error('Error loading sync queue:', error);
    return [];
  }
}

// Main save function (works offline and online)
async function save() {
  // Always save locally first
  saveLocal();
  
  // If online, sync to Firebase
  if (isOnline) {
    try {
      await database.ref('db').set(db);
      lastSyncTime = new Date().toISOString();
      updateOnlineStatus(true, true);
      
      // Clear sync queue on successful save
      if (syncQueue.length > 0) {
        syncQueue = [];
        saveSyncQueue();
      }
    } catch (error) {
      console.error("Error saving to Firebase:", error);
      // Add to sync queue if online but Firebase fails
      addToSyncQueue('full_sync', db);
      updateOnlineStatus(true, false);
    }
  } else {
    // Offline: add to sync queue
    addToSyncQueue('full_sync', db);
    updateOnlineStatus(false);
  }
}

// Add operation to sync queue
function addToSyncQueue(operation, data) {
  syncQueue.push({
    id: uid(),
    operation: operation,
    data: JSON.parse(JSON.stringify(data)), // Deep clone
    timestamp: new Date().toISOString()
  });
  saveSyncQueue();
}

async function load() {
  // Try loading from local storage first (instant)
  const localData = loadLocal();
  
  if (isOnline) {
    try {
      const snapshot = await database.ref('db').once('value');
      let data = snapshot.val();
      
      if (!data) {
        // No Firebase data, use local or init
        if (localData) {
          console.log('Using local storage data (Firebase empty)');
          return ensureDataStructure(localData);
        }
        return initDB();
      }
      
      // Compare timestamps to use most recent data
      const firebaseTime = data.lastModified || 0;
      const localTime = lastSyncTime || 0;
      
      if (localData && localTime > firebaseTime) {
        console.log('Local data is newer, syncing to Firebase...');
        await database.ref('db').set(localData);
        return ensureDataStructure(localData);
      }
      
      console.log('Loaded data from Firebase');
      return ensureDataStructure(data);
      
    } catch (error) {
      console.error("Error loading from Firebase:", error);
      
      // Fallback to local storage
      if (localData) {
        console.log('Firebase failed, using local storage');
        updateOnlineStatus(true, false);
        return ensureDataStructure(localData);
      }
      
      return initDB();
    }
  } else {
    // Offline mode
    console.log('Offline mode: using local storage');
    updateOnlineStatus(false);
    
    if (localData) {
      return ensureDataStructure(localData);
    }
    return initDB();
  }
}

// Ensure data structure has all required fields
function ensureDataStructure(data) {
  data.stores = data.stores || [];
  data.products = data.products || [];
  data.stock = data.stock || [];
  data.alerts = data.alerts || [];
  data.reorderSuggestions = data.reorderSuggestions || [];
  data.cashReconciliation = data.cashReconciliation || [];
  data.customers = data.customers || [];
  data.invoices = data.invoices || [];
  data.transfers = data.transfers || [];
  data.purchases = data.purchases || [];
  data.users = data.users || [];
  data.seq = data.seq || {inv:1,trn:1,pur:1};
  return data;
}
function uid(){ return Math.random().toString(36).slice(2,10); }
function today(){ const d=new Date(); return d.toISOString().slice(0,10); }

// Update online status indicator
function updateOnlineStatus(online, synced = true) {
  isOnline = online;
  const indicator = $('#status-indicator');
  const text = $('#status-text');
  const statusEl = $('#online-status');
  
  if (!indicator || !text) return;
  
  if (online) {
    if (synced) {
      indicator.style.background = 'var(--good)';
      text.textContent = 'Online';
      text.style.color = 'var(--good)';
      statusEl.title = `Connected to Firebase\nLast sync: ${lastSyncTime ? new Date(lastSyncTime).toLocaleString() : 'Just now'}`;
    } else {
      indicator.style.background = 'var(--warn)';
      text.textContent = 'Syncing...';
      text.style.color = 'var(--warn)';
      statusEl.title = 'Connection available but sync pending';
    }
  } else {
    indicator.style.background = 'var(--danger)';
    text.textContent = 'Offline';
    text.style.color = 'var(--danger)';
    const queueCount = syncQueue.length;
    statusEl.title = `Offline Mode\n${queueCount} change${queueCount !== 1 ? 's' : ''} pending sync`;
  }
}

// Sync pending changes to Firebase
async function syncToFirebase() {
  if (!isOnline || syncQueue.length === 0) return;
  
  console.log(`Syncing ${syncQueue.length} pending changes...`);
  updateOnlineStatus(true, false);
  
  try {
    // Sync the full database state
    await database.ref('db').set(db);
    
    // Clear sync queue on success
    syncQueue = [];
    saveSyncQueue();
    lastSyncTime = new Date().toISOString();
    localStorage.setItem(LAST_SYNC_KEY, lastSyncTime);
    
    updateOnlineStatus(true, true);
    console.log('Sync completed successfully');
    
    // Show notification
    showNotification('‚úÖ All changes synced to cloud', 'success');
  } catch (error) {
    console.error('Sync failed:', error);
    updateOnlineStatus(true, false);
    showNotification('‚ö†Ô∏è Sync failed. Will retry automatically.', 'warn');
  }
}

// Show notification toast
function showNotification(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.style.cssText = `
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: ${type === 'success' ? 'var(--good)' : type === 'warn' ? 'var(--warn)' : 'var(--accent)'};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    font-weight: 500;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Monitor connection status
window.addEventListener('online', async () => {
  console.log('Connection restored');
  isOnline = true;
  updateOnlineStatus(true, false);
  showNotification('üåê Connection restored. Syncing...', 'success');
  
  // Wait a moment for connection to stabilize
  setTimeout(async () => {
    await syncToFirebase();
  }, 1000);
});

window.addEventListener('offline', () => {
  console.log('Connection lost');
  isOnline = false;
  updateOnlineStatus(false);
  showNotification('üì± Working offline. Changes will sync when online.', 'warn');
});

// Periodic sync check (every 30 seconds)
setInterval(() => {
  if (isOnline && syncQueue.length > 0) {
    syncToFirebase();
  }
}, 30000);

/* ====== Navigation ====== */
const allSections = [
  {id:'dashboard',label:'Dashboard', icon: 'üìä', roles: ['admin', 'manager']},
  {id:'alerts',label:'Alerts', icon: 'üîî', roles: ['admin', 'manager', 'stockkeeper']},
  {id:'stores',label:'Stores', icon: 'üè™', roles: ['admin', 'manager']},
  {id:'catalog',label:'Products', icon: 'üì¶', roles: ['admin', 'manager', 'stockkeeper']},
  {id:'stock',label:'Inventory', icon: 'üìù', roles: ['admin', 'manager', 'stockkeeper']},
  {id:'purchase',label:'Purchase', icon: 'üì•', roles: ['admin', 'manager', 'stockkeeper']},
  {id:'transfer',label:'Transfer', icon: '‚úàÔ∏è', roles: ['admin', 'manager', 'stockkeeper']},
  {id:'pos',label:'POS Billing', icon: 'üõí', roles: ['admin', 'manager', 'cashier']},
  {id:'returns',label:'Returns', icon: '‚Ü©Ô∏è', roles: ['admin', 'manager', 'cashier']},
  {id:'customers',label:'Customers', icon: 'üë•', roles: ['admin', 'manager', 'cashier']},
  {id:'users',label:'Users', icon: 'üë§', roles: ['admin']},
  {id:'reports',label:'Reports', icon: 'üìà', roles: ['admin', 'manager']},
  {id:'settings',label:'Settings', icon: '‚öôÔ∏è', roles: ['admin']}
];
const tabsEl = $('#tabs');

function renderTabs() {
  if (!tabsEl) return;
  tabsEl.innerHTML = '';
  const userRole = currentUser ? currentUser.role : 'admin';
  const sections = allSections.filter(s => !s.roles || s.roles.includes(userRole));
  const activeAlerts = db.alerts ? db.alerts.filter(a => a.status === 'active').length : 0;
  sections.forEach(s=>{
    const b=document.createElement('button');
    let label = `${s.icon} ${s.label}`;
    if (s.id === 'alerts' && activeAlerts > 0) {
      label += ` <span style="background:var(--danger);color:white;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:4px;">${activeAlerts}</span>`;
    }
    b.innerHTML = label; b.className='tab'; b.onclick=()=>open(s.id);
    b.dataset.id=s.id; tabsEl.appendChild(b);
  });
}
function setActive(id){ $$('#tabs .tab').forEach(t=>t.classList.toggle('active',t.dataset.id===id)); }
function open(id){
  console.log(`Opening section: ${id}`);
  
  // Check if user has permission to access this section
  const userRole = currentUser ? currentUser.role : 'admin';
  const section = allSections.find(s => s.id === id);
  if (section && section.roles && !section.roles.includes(userRole)) {
    alert(`Access Denied: You don't have permission to access ${section.label}. Your role: ${userRole}`);
    // Redirect to default page for role
    const defaultPage = userRole === 'cashier' ? 'pos' : userRole === 'stockkeeper' ? 'stock' : 'dashboard';
    if (id !== defaultPage) {
      open(defaultPage);
    }
    return;
  }
  
  setActive(id);
  const v=$('#view'); v.innerHTML='';
  const renderers = {
    dashboard: renderDashboard,
    alerts: renderAlerts,
    stores: renderStores,
    catalog: renderCatalog,
    stock: renderStock,
    purchase: renderPurchase,
    transfer: renderTransfer,
    pos: renderPOS,
    returns: renderReturns,
    customers: renderCustomers,
    users: renderUsers,
    reports: renderReports,
    settings: renderSettings
  };
  console.log('Available renderers:', renderers);
  const render = renderers[id];
  if (typeof render === 'function') {
    render(v);
  } else {
    console.error(`No render function for id: ${id}`);
  }
}

function renderLoginScreen() {
  const viewElement = $('#view');
  if (!viewElement) return;
  
  viewElement.innerHTML = `
    <div class="card" style="max-width: 400px; margin: 48px auto;">
      <h3>Login / Sign Up</h3>
      <div class="section stack">
        <input id="email" type="email" class="input" placeholder="Email">
        <input id="password" type="password" class="input" placeholder="Password">
        <div class="row">
          <button id="loginBtn" class="btn">Login</button>
          <button id="signupBtn" class="btn secondary">Sign Up</button>
        </div>
        <div id="authMessage" class="muted" style="margin-top: 8px;"></div>
      </div>
    </div>
  `;
  
  const loginBtn = $('#loginBtn');
  const signupBtn = $('#signupBtn');
  const authMessage = $('#authMessage');
  
  if (loginBtn) {
    loginBtn.onclick = async () => {
      try {
        const emailInput = $('#email');
        const passwordInput = $('#password');
        if (emailInput && passwordInput) {
          await auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value);
          authMessage.textContent = 'Login successful!';
          authMessage.style.color = 'var(--good)';
        }
      } catch (error) {
        authMessage.textContent = error.message;
        authMessage.style.color = 'var(--danger)';
      }
    };
  }
  
  if (signupBtn) {
    signupBtn.onclick = async () => {
      try {
        const emailInput = $('#email');
        const passwordInput = $('#password');
        if (emailInput && passwordInput) {
          await auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value);
          authMessage.textContent = 'Account created successfully!';
          authMessage.style.color = 'var(--good)';
        }
      } catch (error) {
        authMessage.textContent = error.message;
        authMessage.style.color = 'var(--danger)';
      }
    };
  }
}

/* ====== Helpers ====== */
function money(n){ return (n||0).toFixed(2); }
function getStore(id){ return db.stores.find(s=>s.id===id); }
function getProduct(id){ return db.products.find(p=>p.id===id); }
function findVariant(p,size,color){ return (p.variants||[]).find(v=>v.size===size && v.color===color); }
function stockQty(storeId, productId, size, color){
  const r = db.stock.find(s=>s.storeId===storeId && s.productId===productId && s.size===size && s.color===color);
  return r? r.qty : 0;
}
function adjustStock(storeId, productId, size, color, delta){
  let r = db.stock.find(s=>s.storeId===storeId && s.productId===productId && s.size===size && s.color===color);
  if(!r){ r={storeId,productId,size,color,qty:0,min:0}; db.stock.push(r); }
  r.qty = Math.max(0, (r.qty||0) + delta);
  // Check if stock is now low
  if (r.min > 0 && r.qty <= r.min) {
    checkLowStock(storeId, productId, size, color);
  }
}

function checkLowStock(storeId, productId, size, color) {
  const stockItem = db.stock.find(s=>s.storeId===storeId && s.productId===productId && s.size===size && s.color===color);
  if (!stockItem || stockItem.qty > stockItem.min) return;
  
  // Check if alert already exists
  const alertKey = `${storeId}-${productId}-${size}-${color}`;
  const existingAlert = db.alerts.find(a => a.key === alertKey && a.status === 'active');
  if (existingAlert) return; // Already alerted
  
  // Calculate reorder quantity based on sales velocity
  const salesVelocity = calculateSalesVelocity(productId, size, color);
  const reorderQty = Math.max(stockItem.min * 2, Math.ceil(salesVelocity * 30)); // 30 days supply
  
  // Create alert
  const alert = {
    id: uid(),
    key: alertKey,
    type: 'low_stock',
    status: 'active',
    storeId,
    productId,
    size,
    color,
    currentQty: stockItem.qty,
    minQty: stockItem.min,
    reorderQty,
    salesVelocity: salesVelocity.toFixed(2),
    createdAt: new Date().toISOString(),
    createdBy: currentUser ? currentUser.id : null
  };
  
  db.alerts.push(alert);
  
  // Create reorder suggestion
  const suggestion = {
    id: uid(),
    alertId: alert.id,
    storeId,
    productId,
    size,
    color,
    suggestedQty: reorderQty,
    status: 'pending',
    createdAt: new Date().toISOString()
  };
  db.reorderSuggestions.push(suggestion);
}

function calculateSalesVelocity(productId, size, color) {
  // Calculate average daily sales for last 30 days
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().slice(0, 10);
  
  let totalSold = 0;
  let daysWithSales = 0;
  
  db.invoices.forEach(inv => {
    if (inv.date >= thirtyDaysAgoStr && !inv.number?.startsWith('REF-')) {
      inv.items.forEach(item => {
        if (item.productId === productId && item.size === size && item.color === color) {
          totalSold += item.qty;
        }
      });
    }
  });
  
  return totalSold / 30; // Average per day
}

function printInvoice(inv) {
    const printerSettings = JSON.parse(localStorage.getItem('printerSettings') || '{"type":"browser","paperWidth":"80","autoPrint":false,"copies":1}');
    
    // Auto print if enabled
    if (printerSettings.autoPrint && printerSettings.type !== 'escpos') {
      printDirect(inv, printerSettings);
      return;
    }
    
    const modal = document.getElementById('print-modal');
    const previewContent = document.getElementById('preview-content');
    const closeModal = document.getElementById('close-modal');
    const printBtn = document.getElementById('print-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    const st = getStore(inv.storeId);
    
    // Format based on printer type
    if (printerSettings.type === 'thermal' || printerSettings.type === 'thermal80') {
      previewContent.innerHTML = formatThermalInvoice(inv, st, printerSettings.paperWidth);
    } else if (printerSettings.type === 'escpos') {
      previewContent.innerHTML = `
        <div style="padding:20px;text-align:center;">
          <h3>ESC/POS Direct Print</h3>
          <p class="muted">This will send the receipt directly to your thermal printer</p>
          <button class="btn green" id="escposPrint" style="margin:20px auto;">üñ®Ô∏è Print to ESC/POS Printer</button>
        </div>
      `;
      modal.style.display = 'block';
      
      $('#escposPrint').onclick = async () => {
        await printESCPOS(inv, st);
        modal.style.display = 'none';
      };
      
      closeModal.onclick = () => modal.style.display = 'none';
      cancelBtn.onclick = () => modal.style.display = 'none';
      return;
    } else {
      previewContent.innerHTML = formatInvoice(inv, st);
    }
    
    modal.style.display = 'block';

    const closeModalHandler = () => {
        modal.style.display = 'none';
        cleanup();
    };

    const printHandler = () => {
        // Print multiple copies if configured
        for (let i = 0; i < printerSettings.copies; i++) {
          window.print();
        }
        modal.style.display = 'none';
        cleanup();
    };

    const windowClickHandler = (event) => {
        if (event.target == modal) {
            modal.style.display = 'none';
            cleanup();
        }
    };

    const cleanup = () => {
        closeModal.removeEventListener('click', closeModalHandler);
        cancelBtn.removeEventListener('click', closeModalHandler);
        printBtn.removeEventListener('click', printHandler);
        window.removeEventListener('click', windowClickHandler);
    };

    closeModal.addEventListener('click', closeModalHandler);
    cancelBtn.addEventListener('click', closeModalHandler);
    printBtn.addEventListener('click', printHandler);
    window.addEventListener('click', windowClickHandler);
}

// Direct print without preview
function printDirect(inv, settings) {
  const modal = document.getElementById('print-modal');
  const previewContent = document.getElementById('preview-content');
  const st = getStore(inv.storeId);
  
  if (settings.type === 'thermal' || settings.type === 'thermal80') {
    previewContent.innerHTML = formatThermalInvoice(inv, st, settings.paperWidth);
  } else {
    previewContent.innerHTML = formatInvoice(inv, st);
  }
  
  modal.style.display = 'block';
  
  setTimeout(() => {
    for (let i = 0; i < settings.copies; i++) {
      window.print();
    }
    modal.style.display = 'none';
  }, 100);
}

// Format invoice for thermal printers
function formatThermalInvoice(inv, store, paperWidth) {
    const cust = inv.customerId ? db.customers.find(c => c.id === inv.customerId) : null;
    const width = paperWidth === '58' ? '200px' : '280px';
    const fontSize = paperWidth === '58' ? '7pt' : '8pt';
    
    let html = `
        <div style="font-family: 'Courier New', monospace; font-size: ${fontSize}; width: ${width}; margin: 0 auto; padding: 5px; background: white; color: black;">
            <div style="text-align: center; border-bottom: 1px dashed black; padding-bottom: 5px; margin-bottom: 5px;">
                <div style="font-size: ${paperWidth === '58' ? '10pt' : '12pt'}; font-weight: bold; color: black;">${store?.name || 'CLOTHIX RETAIL'}</div>
                <div style="font-size: 7pt; color: black;">${store?.address || ''}</div>
                <div style="font-size: 7pt; color: black;">${store?.phone || ''}</div>
            </div>
            
            <table style="width: 100%; font-size: ${fontSize}; margin: 3px 0; color: black;">
                <tr>
                    <td style="color: black;"><strong>Bill:</strong> ${inv.number}</td>
                    <td style="text-align: right; color: black;">${inv.date}</td>
                </tr>
                <tr>
                    <td colspan="2" style="color: black;">${inv.time}</td>
                </tr>
                ${cust ? `<tr><td colspan="2" style="color: black;"><strong>Cust:</strong> ${cust.name}</td></tr>` : ''}
            </table>
            
            <div style="border-top: 1px dashed black; border-bottom: 1px dashed black; padding: 3px 0; margin: 3px 0;">`;
    
    inv.items.forEach((it) => {
        const p = getProduct(it.productId) || {};
        const base = (it.price || 0) * (it.qty || 0);
        const disc = base * (it.discount || 0) / 100;
        const lineTotal = base - disc;
        
        html += `
                <div style="margin-bottom: 3px;">
                    <div style="color: black;"><strong>${p.name || 'N/A'}</strong></div>
                    <div style="color: black;">  ${it.size}/${it.color} x ${it.qty} @ ‚Çπ${money(it.price)} ${it.discount > 0 ? '(-' + it.discount + '%)' : ''}</div>
                    <div style="text-align: right; color: black;">‚Çπ${money(lineTotal)}</div>
                </div>`;
    });

    html += `
            </div>
            
            <table style="width: 100%; font-size: ${fontSize}; margin: 3px 0; color: black;">
                <tr>
                    <td style="text-align: right; color: black;">Subtotal:</td>
                    <td style="text-align: right; width: 60px; color: black;">‚Çπ${money(inv.totals.sub)}</td>
                </tr>
                <tr>
                    <td style="text-align: right; color: black;">Tax (GST):</td>
                    <td style="text-align: right; color: black;">‚Çπ${money(inv.totals.tax)}</td>
                </tr>
                ${inv.totals.round !== 0 ? `
                <tr>
                    <td style="text-align: right; color: black;">Rounding:</td>
                    <td style="text-align: right; color: black;">‚Çπ${money(inv.totals.round)}</td>
                </tr>` : ''}
                <tr style="border-top: 1px dashed black; font-weight: bold;">
                    <td style="text-align: right; font-size: ${paperWidth === '58' ? '9pt' : '10pt'}; padding-top: 3px; color: black;">TOTAL:</td>
                    <td style="text-align: right; font-size: ${paperWidth === '58' ? '9pt' : '10pt'}; padding-top: 3px; color: black;">‚Çπ${money(inv.totals.total)}</td>
                </tr>
            </table>
            
            <div style="margin: 3px 0; font-size: ${fontSize}; color: black;">
                <strong>Payment:</strong>
                ${Array.isArray(inv.payments) ? 
                  inv.payments.map(p => `${p.mode}: ‚Çπ${money(p.amount)}`).join(', ') :
                  `${inv.payments.mode}${inv.payments.amount ? ': ‚Çπ' + money(inv.payments.amount) : ''}`
                }
            </div>
            
            ${inv.notes ? `<div style="margin: 3px 0; font-size: 7pt; color: black;">${inv.notes}</div>` : ''}
            
            <div style="text-align: center; margin: 5px 0; padding-top: 5px; border-top: 1px dashed black;">
                <div style="font-size: ${paperWidth === '58' ? '8pt' : '9pt'}; font-weight: bold; color: black;">THANK YOU!</div>
                <div style="font-size: 7pt; color: black;">Visit Again</div>
            </div>
            
            <div style="text-align: center; margin-top: 10px; font-size: 6pt; color: black;">
                ${'='.repeat(paperWidth === '58' ? 16 : 24)}
            </div>
        </div>
    `;
    return html;
}

// ESC/POS Direct Printing (Web Serial API)
async function printESCPOS(inv, store) {
  if (!('serial' in navigator)) {
    alert('Web Serial API not supported in this browser. Please use Chrome/Edge.');
    return;
  }
  
  try {
    // Request port
    const port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    
    const writer = port.writable.getWriter();
    const encoder = new TextEncoder();
    
    // ESC/POS Commands
    const ESC = '\x1B';
    const GS = '\x1D';
    const INIT = ESC + '@';
    const CENTER = ESC + 'a' + '\x01';
    const LEFT = ESC + 'a' + '\x00';
    const BOLD_ON = ESC + 'E' + '\x01';
    const BOLD_OFF = ESC + 'E' + '\x00';
    const CUT = GS + 'V' + '\x00';
    const FEED = '\n';
    
    // Build receipt
    let receipt = INIT;
    receipt += CENTER + BOLD_ON + (store?.name || 'CLOTHIX RETAIL') + BOLD_OFF + FEED;
    receipt += LEFT + (store?.address || '') + FEED;
    receipt += (store?.phone || '') + FEED + FEED;
    
    const cust = inv.customerId ? db.customers.find(c => c.id === inv.customerId) : null;
    receipt += 'Bill: ' + inv.number + '  ' + inv.date + FEED;
    receipt += inv.time + FEED;
    if (cust) receipt += 'Customer: ' + cust.name + FEED;
    receipt += '--------------------------------' + FEED;
    
    inv.items.forEach(it => {
      const p = getProduct(it.productId) || {};
      const lineTotal = (it.price * it.qty) * (1 - (it.discount || 0) / 100);
      receipt += p.name + FEED;
      receipt += `  ${it.size}/${it.color} x${it.qty} @ ${money(it.price)}` + FEED;
      receipt += `  Total: Rs.${money(lineTotal)}` + FEED;
    });
    
    receipt += '--------------------------------' + FEED;
    receipt += `Subtotal:        Rs.${money(inv.totals.sub)}` + FEED;
    receipt += `Tax (GST):       Rs.${money(inv.totals.tax)}` + FEED;
    if (inv.totals.round !== 0) {
      receipt += `Rounding:        Rs.${money(inv.totals.round)}` + FEED;
    }
    receipt += BOLD_ON + `TOTAL:           Rs.${money(inv.totals.total)}` + BOLD_OFF + FEED;
    receipt += '--------------------------------' + FEED;
    
    const payments = Array.isArray(inv.payments) ? inv.payments : [inv.payments];
    receipt += 'Payment: ' + payments.map(p => `${p.mode}: Rs.${money(p.amount)}`).join(', ') + FEED;
    
    receipt += FEED + CENTER + BOLD_ON + 'THANK YOU!' + BOLD_OFF + FEED;
    receipt += 'Visit Again' + FEED + FEED + FEED;
    receipt += CUT;
    
    // Send to printer
    await writer.write(encoder.encode(receipt));
    await writer.close();
    await port.close();
    
    showNotification('‚úÖ Receipt printed successfully', 'success');
  } catch (error) {
    console.error('Print error:', error);
    alert('Print failed: ' + error.message);
  }
}

function formatInvoice(inv, store) {
    const cust = inv.customerId ? db.customers.find(c => c.id === inv.customerId) : null;
    let html = `
        <div style="font-family: Arial, sans-serif; font-size: 9pt; width: 100%; max-width: 550px; margin: 0; padding: 5px; background: white; color: black;">
            <div style="text-align: center; border-bottom: 1px solid black; padding-bottom: 3px; margin-bottom: 5px;">
                <h2 style="margin: 0; font-size: 12pt; font-weight: bold; color: black;">${store?.name || 'Clothix Retail'}</h2>
                <p style="margin: 1px 0; font-size: 8pt; color: black;">${store?.address || ''} | ${store?.phone || ''}</p>
            </div>
            
            <table style="width: 100%; font-size: 8pt; margin: 3px 0; color: black;">
                <tr>
                    <td style="padding: 1px; color: black;"><strong>Invoice:</strong> ${inv.number}</td>
                    <td style="padding: 1px; text-align: right; color: black;">${inv.date} ${inv.time}</td>
                </tr>
                ${cust ? `<tr><td colspan="2" style="padding: 1px; color: black;"><strong>Customer:</strong> ${cust.name}${cust.phone ? ' | ' + cust.phone : ''}</td></tr>` : '<tr><td colspan="2" style="padding: 1px; color: black;">Walk-in Customer</td></tr>'}
            </table>
            
            <table style="width: 100%; border-collapse: collapse; margin: 3px 0; font-size: 8pt; color: black;">
                <thead>
                    <tr style="border-top: 1px solid black; border-bottom: 1px solid black; background: white;">
                        <th style="text-align: left; padding: 2px; color: black;">Item</th>
                        <th style="text-align: center; padding: 2px; color: black;">Qty</th>
                        <th style="text-align: right; padding: 2px; color: black;">Price</th>
                        ${inv.items.some(it => it.discount > 0) ? '<th style="text-align: right; padding: 2px; color: black;">Disc</th>' : ''}
                        <th style="text-align: right; padding: 2px; color: black;">Total</th>
                    </tr>
                </thead>
                <tbody>
    `;

    inv.items.forEach((it, idx) => {
        const p = getProduct(it.productId) || {};
        const base = (it.price || 0) * (it.qty || 0);
        const disc = base * (it.discount || 0) / 100;
        const lineTotal = base - disc;
        html += `
            <tr style="background: white;">
                <td style="padding: 2px; border-bottom: 1px solid #ddd; color: black;">
                    <strong>${p.name || 'N/A'}</strong> <span style="font-size: 7pt; color: #555;">(${it.size}/${it.color})</span>
                </td>
                <td style="text-align: center; padding: 2px; border-bottom: 1px solid #ddd; color: black;">${it.qty}</td>
                <td style="text-align: right; padding: 2px; border-bottom: 1px solid #ddd; color: black;">‚Çπ${money(it.price)}</td>
                ${inv.items.some(it => it.discount > 0) ? `<td style="text-align: right; padding: 2px; border-bottom: 1px solid #ddd; color: black;">${it.discount > 0 ? it.discount + '%' : '-'}</td>` : ''}
                <td style="text-align: right; padding: 2px; border-bottom: 1px solid #ddd; color: black;">‚Çπ${money(lineTotal)}</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
            
            <table style="width: 100%; font-size: 8pt; margin: 3px 0; color: black;">
                <tr>
                    <td style="padding: 1px; text-align: right; color: black;">Subtotal:</td>
                    <td style="padding: 1px; text-align: right; width: 70px; color: black;">‚Çπ ${money(inv.totals.sub)}</td>
                </tr>
                <tr>
                    <td style="padding: 1px; text-align: right; color: black;">Tax (GST):</td>
                    <td style="padding: 1px; text-align: right; color: black;">‚Çπ ${money(inv.totals.tax)}</td>
                </tr>
                ${inv.totals.round !== 0 ? `
                <tr>
                    <td style="padding: 1px; text-align: right; color: black;">Rounding:</td>
                    <td style="padding: 1px; text-align: right; color: black;">‚Çπ ${money(inv.totals.round)}</td>
                </tr>
                ` : ''}
                <tr style="border-top: 1px solid black; font-weight: bold; background: white;">
                    <td style="padding: 3px 1px; text-align: right; font-size: 10pt; color: black;">TOTAL:</td>
                    <td style="padding: 3px 1px; text-align: right; font-size: 10pt; color: black;">‚Çπ ${money(inv.totals.total)}</td>
                </tr>
            </table>
            
            <div style="margin: 3px 0; font-size: 8pt; color: black;">
                <strong>Payment:</strong>
                ${Array.isArray(inv.payments) ? 
                  inv.payments.map(p => `${p.mode}: ‚Çπ${money(p.amount)}`).join(', ') :
                  `${inv.payments.mode}${inv.payments.amount ? ' - ‚Çπ' + money(inv.payments.amount) : ''}`
                }
            </div>
            
            ${inv.notes ? `<p style="margin: 2px 0; font-size: 7pt; color: black;"><strong>Notes:</strong> ${inv.notes}</p>` : ''}
            
            <div style="text-align: center; margin: 5px 0 3px 0; padding-top: 5px; border-top: 1px dashed black;">
                <p style="margin: 2px 0; font-size: 9pt; font-weight: bold; color: black;">Thank You!</p>
                <p style="margin: 1px 0; font-size: 7pt; color: #555;">GST Invoice | No Returns/Exchange</p>
            </div>
        </div>
    `;
    return html;
}

/* ====== Dashboard ====== */
function renderDashboard(root){
  const totalStyles = db.products.length;
  const totalStores = db.stores.length;
  const totalQty = db.stock.reduce((a,s)=>a+s.qty,0);
  const todaySales = db.invoices.filter(inv=>inv.date===today()).reduce((a,inv)=>a+(inv.totals?.total||0),0);
  const activeAlerts = db.alerts ? db.alerts.filter(a => a.status === 'active').length : 0;
  
  root.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Filters</h3>
        <div class="section stack">
          ${activeAlerts > 0 ? `
          <div style="background:var(--danger);color:white;padding:12px;border-radius:8px;margin-bottom:12px;">
            <strong>‚ö†Ô∏è ${activeAlerts} Low Stock Alert${activeAlerts > 1 ? 's' : ''}</strong>
            <p style="margin:4px 0 8px 0;font-size:13px;">Critical items need reordering</p>
            <button class="btn" style="background:white;color:var(--danger)" onclick="open('alerts')">View Alerts</button>
          </div>
          ` : ''}
          <div class="chips">
            <span class="chip">Today ${today()}</span>
            <span class="chip">Stores ${totalStores}</span>
            <span class="chip">Styles ${totalStyles}</span>
          </div>
          <div class="stack">
            <div class="row">
              <select class="select" id="dashStore">
                <option value="">All Stores</option>
                ${db.stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
              </select>
              <input class="input" id="dashQuery" placeholder="Search style/sku/brand">
            </div>
            <div class="row">
              <button class="btn" id="dashRefresh">Refresh</button>
              <a class="pill link" href="javascript:void(0)" id="toPOS">Go to POS</a>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Overview</h3>
        <div class="section">
          <div class="totals">
            <div class="kpi"><h4>Today Sales</h4><div class="val mono">‚Çπ ${money(todaySales)}</div></div>
            <div class="kpi"><h4>Total Qty</h4><div class="val mono">${totalQty}</div></div>
            <div class="kpi"><h4>Stores</h4><div class="val mono">${totalStores}</div></div>
            <div class="kpi"><h4>Styles</h4><div class="val mono">${totalStyles}</div></div>
          </div>
        </div>
        <div class="section">
          <div class="table-container">
            <table>
              <thead><tr><th>Low Stock</th><th>Store</th><th>Style</th><th>Variant</th><th class="right">Qty</th></tr></thead>
              <tbody id="lowBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
  $('#dashRefresh').onclick = fillLow;
  $('#toPOS').onclick = ()=>open('pos');
  fillLow();
  function fillLow(){
    const storeId = $('#dashStore').value || null;
    const q = ($('#dashQuery').value||'').toLowerCase();
    const lows = db.stock.filter(s=>{
      if(storeId && s.storeId!==storeId) return false;
      const p=getProduct(s.productId)||{};
      const hit = [p.name,p.sku,p.brand].filter(Boolean).join(' ').toLowerCase().includes(q);
      const isLow = (s.min||0)>0 && s.qty<=s.min;
      return hit && isLow;
    });
    const body = $('#lowBody');
    body.innerHTML = lows.map(s=>{
      const st=getStore(s.storeId); const p=getProduct(s.productId)||{};
      return `<tr><td><span class="status low">Low</span></td><td>${st?.name||'-'}</td><td>${p.name||'-'}</td><td>${s.size||''}/${s.color||''}</td><td class="right">${s.qty}</td></tr>`;
    }).join('') || `<tr><td colspan="5" class="muted">No low stock.</td></tr>`;
  }
}

/* ====== Stores ====== */
function renderStores(root){
  root.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Add / Edit Store</h3>
        <div class="section stack">
          <input id="stName" class="input" placeholder="Store name">
          <div class="row">
            <input id="stCode" class="input" placeholder="Code (e.g., BLR-01)">
            <input id="stPhone" class="input" placeholder="Phone">
          </div>
          <textarea id="stAddr" class="input" rows="3" placeholder="Address"></textarea>
          <div class="row">
            <button class="btn" id="stAdd">Save Store</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Stores</h3>
        <div class="section">
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Code</th><th>Phone</th><th>Address</th><th></th></tr></thead>
              <tbody id="stBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
  $('#stAdd').onclick=async ()=>{
    const s={id:uid(),name:$('#stName').value.trim(),code:$('#stCode').value.trim(),phone:$('#stPhone').value.trim(),address:$('#stAddr').value.trim()};
    if(!s.name) return alert('Store name is required');
    db.stores.push(s); await save(); renderStores(root);
  };
  const body=$('#stBody');
  body.innerHTML = db.stores.map(s=>`
    <tr><td>${s.name}</td><td>${s.code||''}</td><td>${s.phone||''}</td><td>${s.address||''}</td>
    <td class="right"><button class="btn red" data-id="${s.id}">Delete</button></td></tr>
  `).join('') || `<tr><td colspan="5" class="muted">No stores yet.</td></tr>`;
  body.querySelectorAll('.btn.red').forEach(b=>{
    b.onclick=async ()=>{ const id=b.dataset.id; if(confirm('Delete store?')){ db.stores=db.stores.filter(x=>x.id!==id); db.stock=db.stock.filter(x=>x.storeId!==id); await save(); renderStores(root);} };
  });
}

/* ====== Catalog (Products with Variants) ====== */
function renderCatalog(root){
  const sizesDefault = 'XS,S,M,L,XL,XXL';
  root.innerHTML = `
    <div class="card">
      <h3>New Product (Style)</h3>
      <div class="section stack">
        <div class="row">
          <input class="input" id="pName" placeholder="Name (e.g., Polo T-Shirt)">
          <input class="input" id="pStyle" placeholder="Style Code">
          <input class="input" id="pBrand" placeholder="Brand">
        </div>
        <div class="row">
          <input class="input" id="pSKU" placeholder="Master SKU">
          <input class="input" id="pBarcode" placeholder="Barcode (master)">
          <input class="input" id="pHSN" placeholder="HSN/SAC">
          <input class="input" id="pTax" placeholder="GST % (e.g., 5, 12)">
        </div>
        <div class="row">
          <input class="input" id="pCategory" placeholder="Category (e.g., Men > Tees)">
          <input class="input" id="pMRP" placeholder="MRP">
          <input class="input" id="pPrice" placeholder="Sale Price">
        </div>
        <div class="row">
          <input class="input" id="pSizes" placeholder="Sizes (comma separated)" value="${sizesDefault}">
          <input class="input" id="pColors" placeholder="Colors (comma separated)">
        </div>
        <div class="row">
          <button class="btn" id="genVar">Generate Variants</button>
          <button class="btn green" id="saveProd">Save Product</button>
        </div>
        <div id="varPreview" class="stack"></div>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Product List</h3>
      <div class="section">
        <div class="row">
          <input class="input" id="pQuery" placeholder="Search name/sku/brand/category">
          <button class="btn" id="pFind">Search</button>
        </div>
      </div>
      <div class="section">
        <div class="table-container">
          <table>
            <thead><tr><th>Name</th><th>Brand</th><th>SKU</th><th>Tax%</th><th>Variants</th><th></th></tr></thead>
            <tbody id="pBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  let currentVariants=[];
  $('#genVar').onclick=()=>{
    const sizes = ($('#pSizes').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const colors = ($('#pColors').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const skuMaster = $('#pSKU').value.trim() || 'SKU';
    const barcodeMaster = $('#pBarcode').value.trim();
    currentVariants = [];
    sizes.forEach(s=>{
      colors.forEach(c=>{
        currentVariants.push({size:s,color:c,sku:`${skuMaster}-${s}-${c}`.toUpperCase(),barcode:barcodeMaster? `${barcodeMaster}${s}${c}`:''});
      });
    });
    const prev = $('#varPreview');
    prev.innerHTML = currentVariants.length? `
      <div class="chips"><span class="chip">Generated ${currentVariants.length} variants</span></div>
      <div class="table-container">
        <table><thead><tr><th>Size</th><th>Color</th><th>SKU</th><th>Barcode</th></tr></thead>
        <tbody>${currentVariants.map(v=>`<tr><td>${v.size}</td><td>${v.color}</td><td class="mono">${v.sku}</td><td class="mono">${v.barcode||''}</td></tr>`).join('')}</tbody></table>
      </div>
    ` : `<div class="muted">Add sizes & colors to generate variants.</div>`;
  };
  $('#saveProd').onclick=async ()=>{
    const p={
      id:uid(),
      name:$('#pName').value.trim(),
      style:$('#pStyle').value.trim(),
      brand:$('#pBrand').value.trim(),
      sku:$('#pSKU').value.trim(),
      barcode:$('#pBarcode').value.trim(),
      hsn:$('#pHSN').value.trim(),
      taxPct: +($('#pTax').value||0),
      category:$('#pCategory').value.trim(),
      mrp:+($('#pMRP').value||0),
      price:+($('#pPrice').value||0),
      sizes:($('#pSizes').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      colors:($('#pColors').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      attributes:{},
      variants: currentVariants
    };
    if(!p.name) return alert('Product name is required');
    db.products.push(p); await save(); alert('Product saved'); renderCatalog(root);
  };
  function fillList(){
    const q=($('#pQuery').value||'').toLowerCase();
    const body=$('#pBody');
    const rows = db.products.filter(p=>{
      return [p.name,p.sku,p.brand,p.category].join(' ').toLowerCase().includes(q);
    }).map(p=>{
      return `<tr>
        <td>${p.name}</td><td>${p.brand||''}</td><td class="mono">${p.sku||''}</td><td>${p.taxPct||0}</td>
        <td><span class="badge">${(p.variants||[]).length} variants</span></td>
        <td class="right"><button class="btn red" data-id="${p.id}">Delete</button></td>
      </tr>`;
    }).join('') || `<tr><td colspan="6" class="muted">No products.</td></tr>`;
    body.innerHTML = rows;
    body.querySelectorAll('.btn.red').forEach(b=>{
      b.onclick=async ()=>{ const id=b.dataset.id; if(confirm('Delete product and stock?')){ db.products=db.products.filter(x=>x.id!==id); db.stock=db.stock.filter(x=>x.productId!==id); await save(); fillList(); } };
    });
  }
  $('#pFind').onclick=fillList; fillList();
}

/* ====== Inventory ====== */
function renderStock(root){
  root.innerHTML = `
    <div class="card">
      <h3>Inventory by Variant</h3>
      <div class="section">
        <div class="row">
          <select class="select" id="sStore">
            <option value="">All Stores</option>
            ${db.stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
          </select>
          <input class="input" id="sQuery" placeholder="Search product/sku/brand">
          <button class="btn" id="sFind">Search</button>
        </div>
      </div>
      <div class="section">
        <div class="table-container">
          <table>
            <thead><tr><th>Store</th><th>Product</th><th>Variant</th><th class="right">Qty</th><th class="right">Min</th><th></th></tr></thead>
            <tbody id="sBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  function fill(){
    const storeId=$('#sStore').value||'';
    const q=($('#sQuery').value||'').toLowerCase();
    const rows = db.stock.filter(r=>{
      const okStore = storeId? r.storeId===storeId : true;
      const p=getProduct(r.productId)||{};
      const okQ = [p.name,p.sku,p.brand].join(' ').toLowerCase().includes(q);
      return okStore && okQ;
    }).map(r=>{
      const st=getStore(r.storeId); const p=getProduct(r.productId)||{};
      return `<tr>
        <td>${st?.name||''}</td>
        <td>${p?.name||''}</td>
        <td>${r.size}/${r.color}</td>
        <td class="right mono">${r.qty}</td>
        <td class="right"><input data-key="min" data-id="${r.storeId}|${r.productId}|${r.size}|${r.color}" class="input" style="width:90px" value="${r.min||0}"></td>
        <td class="right"><button class="btn warn" data-id="${r.storeId}|${r.productId}|${r.size}|${r.color}">Set Min</button></td>
      </tr>`;
    }).join('') || `<tr><td colspan="6" class="muted">No stock yet.</td></tr>`;
    $('#sBody').innerHTML = rows;
    $('#sBody').querySelectorAll('.btn.warn').forEach(b=>{
      b.onclick=async ()=>{
        const [storeId,productId,size,color]=b.dataset.id.split('|');
        const inp=$(`#sBody input[data-id="${b.dataset.id}"]`);
        const val=+inp.value||0;
        const r=db.stock.find(x=>x.storeId===storeId && x.productId===productId && x.size===size && x.color===color);
        if(r){ r.min=val; await save(); alert('Min updated'); }
      };
    });
  }
  $('#sFind').onclick=fill; fill();
}

/* ====== Purchase (Receive Stock) ====== */
function renderPurchase(root){
  root.innerHTML = `
    <div class="split">
      <div class="card">
        <h3>Receive Stock</h3>
        <div class="section stack">
          <div id="autoPoNotice" style="display:none;background:var(--chip);padding:12px;border-radius:8px;margin-bottom:16px;">
            <strong>ü§ñ Auto-Generated Purchase Order</strong>
            <p class="muted" style="margin:4px 0 0 0;font-size:13px;">This PO was created from low stock alerts. Review and adjust quantities as needed.</p>
          </div>
          <div class="row">
            <select class="select" id="puStore">
              <option value="">Select Store</option>
              ${db.stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
            </select>
            <input class="input" id="puRef" placeholder="Supplier Bill/Ref">
            <input class="input" id="puDate" type="date" value="${today()}">
          </div>
          <div class="row">
            <input class="input" id="puSearch" placeholder="Search product by name/sku">
            <button class="btn" id="puAdd">Add Line</button>
          </div>
          <div class="section">
            <div class="table-container">
              <table>
                <thead><tr><th>Product</th><th>Variant</th><th>Qty</th><th>Cost</th><th></th></tr></thead>
                <tbody id="puBody"></tbody>
              </table>
            </div>
          </div>
          <div class="row">
            <button class="btn green" id="puSave">Post Receipt</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Quick Pick</h3>
        <div class="section" id="puPick"></div>
      </div>
    </div>
  `;
  const lines=[];
  
  // Check for auto-generated PO data from alerts
  const singlePOData = localStorage.getItem('singlePOData');
  const bulkPOData = localStorage.getItem('bulkPOData');
  
  if (singlePOData) {
    const data = JSON.parse(singlePOData);
    $('#autoPoNotice').style.display = 'block';
    $('#puStore').value = data.storeId;
    $('#puRef').value = `AUTO-PO-${data.id || Date.now()}`;
    
    // Get average cost from recent purchases
    const recentPurchases = db.purchases.filter(p => 
      p.items.some(i => i.productId === data.productId)
    ).slice(-3);
    
    let avgCost = 0;
    if (recentPurchases.length > 0) {
      const costs = recentPurchases.map(p => {
        const item = p.items.find(i => i.productId === data.productId);
        return item?.cost || 0;
      });
      avgCost = costs.reduce((a,b) => a+b, 0) / costs.length;
    }
    
    lines.push({
      productId: data.productId,
      size: data.size,
      color: data.color,
      qty: data.reorderQty || data.suggestedQty || 10,
      cost: avgCost
    });
    
    localStorage.removeItem('singlePOData');
  } else if (bulkPOData) {
    const storeGroups = JSON.parse(bulkPOData);
    const firstStoreId = Object.keys(storeGroups)[0];
    
    $('#autoPoNotice').style.display = 'block';
    $('#puStore').value = firstStoreId;
    $('#puRef').value = `BULK-AUTO-PO-${Date.now()}`;
    
    // Add all items for first store
    storeGroups[firstStoreId].forEach(alert => {
      const recentPurchases = db.purchases.filter(p => 
        p.items.some(i => i.productId === alert.productId)
      ).slice(-3);
      
      let avgCost = 0;
      if (recentPurchases.length > 0) {
        const costs = recentPurchases.map(p => {
          const item = p.items.find(i => i.productId === alert.productId);
          return item?.cost || 0;
        });
        avgCost = costs.reduce((a,b) => a+b, 0) / costs.length;
      }
      
      lines.push({
        productId: alert.productId,
        size: alert.size,
        color: alert.color,
        qty: alert.reorderQty || 10,
        cost: avgCost
      });
    });
    
    localStorage.removeItem('bulkPOData');
  }
  
  function refreshLines(){
    $('#puBody').innerHTML = lines.map((ln,i)=>`
      <tr>
        <td>${getProduct(ln.productId)?.name||''}</td>
        <td>${ln.size}/${ln.color}</td>
        <td><input class="input" style="width:90px" value="${ln.qty}" data-i="${i}" data-k="qty"></td>
        <td><input class="input" style="width:110px" value="${ln.cost}" data-i="${i}" data-k="cost"></td>
        <td class="right"><button class="btn red" data-i="${i}">Remove</button></td>
      </tr>
    `).join('') || `<tr><td colspan="5" class="muted">Use Quick Pick or Add Line.</td></tr>`;
    $('#puBody').querySelectorAll('input').forEach(inp=>{
      inp.oninput=()=>{ const i=+inp.dataset.i; const k=inp.dataset.k; lines[i][k]= +inp.value||0; };
    });
    $('#puBody').querySelectorAll('.btn.red').forEach(btn=>{
      btn.onclick=()=>{ const i=+btn.dataset.i; lines.splice(i,1); refreshLines(); };
    });
  }
  function refreshPick(){
    const q=($('#puSearch').value||'').toLowerCase();
    const html = db.products.filter(p=>[p.name,p.sku,p.brand].join(' ').toLowerCase().includes(q)).slice(0,50).map(p=>{
      const variants = (p.variants&&p.variants.length? p.variants : [{size:'STD',color:'STD',sku:p.sku,barcode:p.barcode}]);
      return `<div class="card" style="margin-bottom:8px">
        <div class="section">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div>
              <div>${p.name} <span class="badge">${variants.length} variants</span></div>
              <div class="muted mono">${p.brand||''} ‚Ä¢ ${p.sku||''} ‚Ä¢ GST ${p.taxPct||0}%</div>
            </div>
          </div>
          <div class="chips" style="margin-top:8px">
            ${variants.map(v=>`<button class="chip" data-p="${p.id}" data-size="${v.size}" data-color="${v.color}">${v.size}/${v.color}</button>`).join('')}
          </div>
        </div>
      </div>`;
    }).join('') || `<div class="muted">No products.</div>`;
    $('#puPick').innerHTML = html;
    $('#puPick').querySelectorAll('.chip').forEach(ch=>{
      ch.onclick=()=>{
        const productId = ch.dataset.p, size=ch.dataset.size, color=ch.dataset.color;
        lines.push({productId,size,color,qty:1,cost:0});
        refreshLines();
      };
    });
  }
  $('#puAdd').onclick=refreshPick;
  $('#puSearch').oninput=refreshPick;
  $('#puSave').onclick=async ()=>{
    const storeId=$('#puStore').value;
    if(!storeId) return alert('Select store');
    if(!lines.length) return alert('No lines');
    const doc={id:uid(),date:$('#puDate').value,storeId,ref:$('#puRef').value.trim(),items:JSON.parse(JSON.stringify(lines)),note:''};
    db.purchases.push(doc);
    lines.forEach(ln=> {
      adjustStock(storeId,ln.productId,ln.size,ln.color,+ln.qty);
      
      // Resolve related alerts when stock is received
      const alertKey = `${storeId}-${ln.productId}-${ln.size}-${ln.color}`;
      const alert = db.alerts.find(a => a.key === alertKey && a.status === 'active');
      if (alert) {
        alert.status = 'resolved';
        alert.action = 'Stock Received';
        alert.resolvedAt = new Date().toISOString();
        alert.resolvedBy = currentUser ? currentUser.id : null;
        
        // Update related suggestion
        const suggestion = db.reorderSuggestions.find(s => s.alertId === alert.id && s.status === 'pending');
        if (suggestion) {
          suggestion.status = 'completed';
          suggestion.completedAt = new Date().toISOString();
        }
      }
    });
    await save();
    renderTabs(); // Update notification badge
    alert('Receipt posted and alerts resolved!');
    renderPurchase(root);
  };
  refreshPick(); refreshLines();
}

/* ====== Transfer ====== */
function renderTransfer(root){
  root.innerHTML = `
    <div class="card">
      <h3>Inter‚ÄëStore Transfer</h3>
      <div class="section stack">
        <div class="row">
          <select class="select" id="tfFrom"><option value="">From Store</option>${db.stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
          <select class="select" id="tfTo"><option value="">To Store</option>${db.stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
          <input class="input" id="tfDate" type="date" value="${today()}">
        </div>
        <div class="row">
          <input class="input" id="tfSearch" placeholder="Search product">
          <button class="btn" id="tfAdd">Add</button>
        </div>
        <div class="section">
          <div class="table-container">
            <table>
              <thead><tr><th>Product</th><th>Variant</th><th class="right">Avail</th><th>Qty</th><th></th></tr></thead>
              <tbody id="tfBody"></tbody>
            </table>
          </div>
        </div>
        <div class="row">
          <button class="btn green" id="tfPost">Post Transfer</button>
        </div>
      </div>
    </div>
  `;
  const lines=[];
  function fillPick(){
    // simple add via search: pick first 25 matched product variants
    const q=($('#tfSearch').value||'').toLowerCase();
    const matched = db.products.filter(p=>[p.name,p.sku,p.brand].join(' ').toLowerCase().includes(q)).slice(0,25);
    if(!matched.length) return alert('No products match');
    const p=matched[0];
    const variants = p.variants?.length? p.variants : [{size:'STD',color:'STD'}];
    variants.forEach(v=> lines.push({productId:p.id,size:v.size,color:v.color,qty:0}));
    refreshLines();
  }
  function refreshLines(){
    const from=$('#tfFrom').value||'';
    $('#tfBody').innerHTML = lines.map((ln,i)=>{
      const p=getProduct(ln.productId)||{};
      const avail = from? stockQty(from,ln.productId,ln.size,ln.color) : 0;
      return `<tr>
        <td>${p.name||''}</td>
        <td>${ln.size}/${ln.color}</td>
        <td class="right mono">${avail}</td>
        <td><input class="input" style="width:90px" value="${ln.qty}" data-i="${i}"></td>
        <td class="right"><button class="btn red" data-i="${i}">Remove</button></td>
      </tr>`;
    }).join('') || `<tr><td colspan="5" class="muted">Add lines to transfer.</td></tr>`;
    $('#tfBody').querySelectorAll('input').forEach(inp=>{
      inp.oninput=()=>{ lines[+inp.dataset.i].qty=+inp.value||0; };
    });
    $('#tfBody').querySelectorAll('.btn.red').forEach(b=>{
      b.onclick=()=>{ lines.splice(+b.dataset.i,1); refreshLines(); };
    });
  }
  $('#tfAdd').onclick=fillPick;
  $('#tfSearch').onkeydown=(e)=>{ if(e.key==='Enter') fillPick(); };
  $('#tfPost').onclick=async ()=>{
    const from=$('#tfFrom').value, to=$('#tfTo').value;
    if(!from||!to||from===to) return alert('Select different stores');
    const items = lines.filter(l=>l.qty>0);
    if(!items.length) return alert('No quantities');
    items.forEach(ln=>{
      const available = stockQty(from,ln.productId,ln.size,ln.color);
      if(ln.qty>available) throw alert('Insufficient stock for some lines');
    });
    const doc={id:uid(),date:$('#tfDate').value,fromStore:from,toStore:to,items, note:''};
    db.transfers.push(doc);
    items.forEach(ln=>{
      adjustStock(from,ln.productId,ln.size,ln.color,-ln.qty);
      adjustStock(to,ln.productId,ln.size,ln.color,+ln.qty);
    });
    await save(); alert('Transfer posted'); renderTransfer(root);
  };
  refreshLines();
}

/* ====== POS Billing ====== */
function renderPOS(root){
  root.innerHTML = `
    <div class="split">
      <div class="card">
        <h3>POS Billing</h3>
        <div class="section stack">
          <div class="row">
            <select class="select" id="posStore">
              ${db.stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
            </select>
            <input class="input" id="posDate" type="date" value="${today()}">
            <input class="input" id="posNumber" placeholder="Invoice No. (auto)">
          </div>
          <div class="row">
            <input class="input" id="posScan" placeholder="Scan barcode / type SKU / search name">
            <select class="select" id="posCustomer">
              <option value="">Walk-in</option>
              ${db.customers.map(c=>`<option value="${c.id}">${c.name} (${c.phone||''})</option>`).join('')}
            </select>
            <input class="input" id="posGSTIN" placeholder="Customer GSTIN (optional)">
          </div>
        </div>
        <div class="section">
          <div class="table-container">
            <table>
              <thead><tr><th>Item</th><th>Variant</th><th class="right">MRP</th><th class="right">Price</th><th class="right">Qty</th><th class="right">Tax%</th><th class="right">Disc%</th><th class="right">Line</th><th></th></tr></thead>
              <tbody id="posBody"></tbody>
            </table>
          </div>
        </div>
        <div class="section row">
          <button class="btn warn" id="posClear">Clear</button>
          <button class="btn green" id="posPay">Preview & Save</button>
        </div>
      </div>
      <div class="card">
        <h3>Totals & Payment</h3>
        <div class="section stack" id="posTotals"></div>
        <div class="section">
          <h4 style="margin:0 0 12px 0;font-size:14px;color:var(--muted)">Payment Methods</h4>
          <div id="paymentMethods" style="margin-bottom:12px;">
            <!-- Payment lines will be added here -->
          </div>
          <div class="row" style="margin-bottom:12px;">
            <select class="select" id="payMode" style="flex:1">
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="UPI">UPI</option>
              <option value="Wallet">Wallet</option>
              <option value="Credit">Credit</option>
            </select>
            <input class="input" id="payAmt" placeholder="Amount" style="flex:1">
            <button class="btn" id="addPayment">+ Add</button>
          </div>
          <div id="paymentSummary" style="padding:12px;background:var(--panel-2);border-radius:8px;margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <span>Total Amount:</span>
              <span id="totalAmount" class="mono" style="font-weight:bold;">‚Çπ0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <span>Paid Amount:</span>
              <span id="paidAmount" class="mono" style="color:var(--good);font-weight:bold;">‚Çπ0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:4px;">
              <span style="font-weight:bold;">Balance:</span>
              <span id="balanceAmount" class="mono" style="font-weight:bold;font-size:16px;">‚Çπ0.00</span>
            </div>
          </div>
          <div class="row">
            <textarea class="input" id="posNotes" rows="2" placeholder="Notes"></textarea>
          </div>
        </div>
      </div>
    </div>
  `;
  const storeId = db.stores[0]?.id || '';
  if($('#posStore')) $('#posStore').value = storeId;
  const cart=[];
  const payments = []; // Track multiple payment methods
  
  function updatePaymentSummary() {
    const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
    let grandTotal = 0;
    
    // Calculate cart total
    if (cart.length > 0) {
      let sub = 0, tax = 0;
      cart.forEach(it => {
        const base = (it.price || 0) * (it.qty || 0);
        const disc = base * (it.discount || 0) / 100;
        const taxable = Math.max(0, base - disc);
        sub += taxable;
        tax += taxable * (it.taxPct || 0) / 100;
      });
      const total = sub + tax;
      const r = Math.round(total) - total;
      grandTotal = total + r;
    }
    
    const balance = grandTotal - totalPaid;
    
    $('#totalAmount').textContent = '‚Çπ' + money(grandTotal);
    $('#paidAmount').textContent = '‚Çπ' + money(totalPaid);
    $('#balanceAmount').textContent = '‚Çπ' + money(balance);
    $('#balanceAmount').style.color = balance > 0.01 ? 'var(--danger)' : balance < -0.01 ? 'var(--warn)' : 'var(--good)';
    
    // Update payment methods display
    const paymentMethodsEl = $('#paymentMethods');
    if (payments.length === 0) {
      paymentMethodsEl.innerHTML = '<div class="muted" style="font-size:13px;padding:8px;">No payments added yet</div>';
    } else {
      paymentMethodsEl.innerHTML = payments.map((p, idx) => `
        <div style="display:flex;gap:8px;align-items:center;padding:8px;background:var(--panel-2);border-radius:6px;margin-bottom:6px;">
          <span class="badge" style="background:var(--gradient-primary);min-width:60px;">${p.mode}</span>
          <span class="mono" style="flex:1;font-weight:bold;">‚Çπ${money(p.amount)}</span>
          ${p.reference ? `<span class="muted" style="font-size:12px;">${p.reference}</span>` : ''}
          <button class="btn red" style="padding:4px 8px;font-size:12px;" data-idx="${idx}">Remove</button>
        </div>
      `).join('');
      
      // Add remove handlers
      paymentMethodsEl.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.onclick = () => {
          payments.splice(+btn.dataset.idx, 1);
          updatePaymentSummary();
        };
      });
    }
  }
  
  function addByQuery(q){
    q = (q||'').trim();
    if(!q) return;
    // Try barcode/sku exact, else name contains
    let match=null, variant=null;
    for(const p of db.products){
      if(p.barcode===q || p.sku===q){ match=p; break; }
      if(!match){
        for(const v of (p.variants||[])){
          if(v.barcode===q || v.sku===q){ match=p; variant=v; break; }
        }
      }
      if(match&&variant) break;
    }
    if(!match){
      const list=db.products.filter(p=>[p.name,p.sku,p.brand].join(' ').toLowerCase().includes(q.toLowerCase()));
      if(list.length) match=list[0];
    }
    if(!match){ alert('Item not found'); return; }
    const v = variant || (match.variants?.[0] || {size:'STD',color:'STD'});
    const existing = cart.find(it=>it.productId===match.id && it.size===v.size && it.color===v.color);
    if(existing){ existing.qty+=1; }
    else{
      cart.push({
        productId:match.id,
        size:v.size,color:v.color,
        mrp:match.mrp||0,
        price:match.price||match.mrp||0,
        qty:1,
        taxPct:match.taxPct||0,
        discount:0
      });
    }
    $('#posScan').value='';
    refreshCart();
  }
  
  $('#addPayment').onclick = () => {
    const mode = $('#payMode').value;
    const amount = parseFloat($('#payAmt').value);
    
    if (!amount || amount <= 0) {
      return alert('Please enter a valid payment amount');
    }
    
    payments.push({
      mode: mode,
      amount: amount,
      reference: '',
      timestamp: new Date().toISOString()
    });
    
    $('#payAmt').value = '';
    updatePaymentSummary();
  };
  
  $('#payAmt').onkeydown = (e) => {
    if (e.key === 'Enter') {
      $('#addPayment').click();
    }
  };

  function refreshCart(){
    const stId=$('#posStore').value;
    $('#posBody').innerHTML = cart.map((it,i)=>{
      const p=getProduct(it.productId)||{};
      const avail = stockQty(stId,it.productId,it.size,it.color);
      const lineBase = it.price * it.qty;
      const lineDisc = lineBase*(it.discount||0)/100;
      const taxable = Math.max(0,lineBase - lineDisc);
      const tax = taxable * (it.taxPct||0)/100;
      const gross = taxable + tax;
      return `<tr>
        <td>${p.name||''}<div class="muted mono">${p.sku||''}</div></td>
        <td>${it.size}/${it.color}<div class="muted">Avail ${avail}</div></td>
        <td class="right mono">‚Çπ${money(it.mrp)}</td>
        <td class="right"><input class="input" style="width:90px" value="${it.price}" data-i="${i}" data-k="price"></td>
        <td class="right"><input class="input" style="width:70px" value="${it.qty}" data-i="${i}" data-k="qty"></td>
        <td class="right"><input class="input" style="width:70px" value="${it.taxPct}" data-i="${i}" data-k="taxPct"></td>
        <td class="right"><input class="input" style="width:70px" value="${it.discount}" data-i="${i}" data-k="discount"></td>
        <td class="right mono">‚Çπ${money(gross)}</td>
        <td class="right"><button class="btn red" data-i="${i}">X</button></td>
      </tr>`;
    }).join('') || `<tr><td colspan="9" class="muted">Scan or search to add items.</td></tr>`;
    $('#posBody').querySelectorAll('input').forEach(inp=>{
      inp.oninput=()=>{
        const i=+inp.dataset.i, k=inp.dataset.k;
        cart[i][k]= +inp.value||0;
        refreshTotals();
      };
    });
    $('#posBody').querySelectorAll('.btn.red').forEach(b=>{
      b.onclick=()=>{ cart.splice(+b.dataset.i,1); refreshCart(); };
    });
    refreshTotals();
  }
  function refreshTotals(){
    let sub=0,tax=0;
    cart.forEach(it=>{
      const base = (it.price||0) * (it.qty||0);
      const disc = base*(it.discount||0)/100;
      const taxable = Math.max(0,base-disc);
      sub += taxable;
      tax += taxable*(it.taxPct||0)/100;
    });
    const total = sub+tax;
    const r = Math.round(total) - total;
    const grand = total + r;
    $('#posTotals').innerHTML = `
      <div class="totals">
        <div class="kpi"><h4>Subtotal</h4><div class="val mono">‚Çπ ${money(sub)}</div></div>
        <div class="kpi"><h4>Tax</h4><div class="val mono">‚Çπ ${money(tax)}</div></div>
        <div class="kpi"><h4>Round Off</h4><div class="val mono">‚Çπ ${money(r)}</div></div>
        <div class="kpi"><h4>Grand Total</h4><div class="val mono">‚Çπ ${money(grand)}</div></div>
      </div>
    `;
    $('#payAmt').value = money(grand);
  }
  $('#posScan').addEventListener('keydown',e=>{ if(e.key==='Enter'){ addByQuery(e.target.value); } });
  $('#posClear').onclick=()=>{ if(confirm('Clear cart?')){ cart.length=0; payments.length=0; refreshCart(); updatePaymentSummary(); } };
  $('#posPay').onclick=async ()=>{
    const stId=$('#posStore').value;
    if(!stId) return alert('Select store');
    if(!cart.length) return alert('Cart empty');
    // stock check
    for(const it of cart){
      const avail=stockQty(stId,it.productId,it.size,it.color);
      if((it.qty||0)>avail) return alert('Insufficient stock for '+(getProduct(it.productId)?.name||''));
    }
    // totals
    let sub=0,tax=0;
    cart.forEach(it=>{
      const base = (it.price||0)*(it.qty||0);
      const disc = base*(it.discount||0)/100;
      const taxable = Math.max(0,base-disc);
      sub+=taxable; tax+=taxable*(it.taxPct||0)/100;
    });
    const total=sub+tax; const r=Math.round(total)-total; const grand=total+r;
    
    // Validate payments
    const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
    if (Math.abs(totalPaid - grand) > 0.01) {
      const confirmed = confirm(`Payment mismatch! Total: ‚Çπ${money(grand)}, Paid: ‚Çπ${money(totalPaid)}. Continue anyway?`);
      if (!confirmed) return;
    }
    
    // Default to single payment if no split payments added
    const finalPayments = payments.length > 0 ? JSON.parse(JSON.stringify(payments)) : 
      [{mode: $('#payMode').value || 'Cash', amount: grand, reference: '', timestamp: new Date().toISOString()}];
    
    const invNo = $('#posNumber').value.trim() || `INV-${String(db.seq.inv++).padStart(5,'0')}`;
    const inv = {
      id:uid(),
      date:$('#posDate').value,
      time:new Date().toLocaleTimeString(),
      storeId:stId,
      number:invNo,
      customerId:$('#posCustomer').value||'',
      cashierId: currentUser ? currentUser.id : null,
      items: JSON.parse(JSON.stringify(cart)),
      totals:{sub,tax,total:grand,round:r},
      payments: finalPayments, // Now an array of payment methods
      notes:$('#posNotes').value.trim()
    };
    db.invoices.push(inv);
    // stock adjust
    cart.forEach(it=> adjustStock(stId,it.productId,it.size,it.color,-it.qty));
    await save();
    printInvoice(inv);
    payments.length = 0; // Clear payments
    renderPOS(root);
  };

  refreshCart();
  updatePaymentSummary();
}

/* ====== Returns & Exchange ====== */
function renderReturns(root) {
  root.innerHTML = `
    <div class="stack">
      <div class="card">
        <h3>üîÑ Exchange & Refund Management</h3>
        <div class="section">
          <div class="row">
            <input class="input" id="returnInvSearch" placeholder="Enter Invoice Number" style="flex:2">
            <button class="btn" id="returnFindInv">üîç Find Invoice</button>
          </div>
        </div>
        <div id="returnInvDetails" class="section"></div>
      </div>
      
      <div class="card" id="exchangeHistoryCard">
        <h3>üìã Recent Exchanges & Returns</h3>
        <div class="section">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Original Invoice</th>
                  <th>Customer</th>
                  <th class="right">Return Value</th>
                  <th class="right">Exchange Value</th>
                  <th class="right">Difference</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${db.invoices.filter(inv => inv.number?.startsWith('REF-') || inv.number?.startsWith('EXC-'))
                  .sort((a, b) => b.date.localeCompare(a.date))
                  .slice(0, 20)
                  .map(inv => {
                    const isExchange = inv.number?.startsWith('EXC-');
                    const customer = inv.customerId ? db.customers.find(c => c.id === inv.customerId) : null;
                    const originalInv = db.invoices.find(i => i.id === inv.relatedInvoiceId);
                    const returnValue = Math.abs(inv.returnValue || inv.totals?.total || 0);
                    const exchangeValue = inv.exchangeValue || 0;
                    const difference = exchangeValue - returnValue;
                    
                    return `
                      <tr>
                        <td>${inv.date} ${inv.time || ''}</td>
                        <td>
                          <span class="badge" style="background:${isExchange ? 'var(--accent)' : 'var(--danger)'}">
                            ${isExchange ? 'Exchange' : 'Refund'}
                          </span>
                        </td>
                        <td>${originalInv?.number || 'N/A'}</td>
                        <td>${customer?.name || 'Walk-in'}</td>
                        <td class="right mono">‚Çπ${money(returnValue)}</td>
                        <td class="right mono">${isExchange ? '‚Çπ' + money(exchangeValue) : '-'}</td>
                        <td class="right mono" style="color:${difference > 0 ? 'var(--good)' : difference < 0 ? 'var(--danger)' : 'var(--muted)'}">
                          ${isExchange ? (difference >= 0 ? '+' : '') + '‚Çπ' + money(difference) : '-'}
                        </td>
                        <td class="right">
                          <button class="btn secondary" data-id="${inv.id}">View</button>
                        </td>
                      </tr>
                    `;
                  }).join('') || '<tr><td colspan="8" class="muted" style="text-align:center;">No exchanges or returns yet.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;

  $('#returnFindInv').onclick = () => {
    const invNumber = $('#returnInvSearch').value.trim();
    if (!invNumber) return alert('Please enter an invoice number');

    const invoice = db.invoices.find(inv => inv.number === invNumber);
    const detailsContainer = $('#returnInvDetails');

    if (invoice && !invoice.number?.startsWith('REF-') && !invoice.number?.startsWith('EXC-')) {
      const store = getStore(invoice.storeId);
      const customer = invoice.customerId ? db.customers.find(c => c.id === invoice.customerId) : null;
      
      detailsContainer.innerHTML = `
        <div style="background:var(--panel-2);padding:16px;border-radius:8px;margin-bottom:16px;">
          <h4 style="margin:0 0 12px 0;">Invoice Details</h4>
          <div class="chips">
            <span class="chip">Invoice: ${invoice.number}</span>
            <span class="chip">Date: ${invoice.date} ${invoice.time}</span>
            <span class="chip">Store: ${store ? store.name : 'N/A'}</span>
            <span class="chip">Customer: ${customer?.name || 'Walk-in'}</span>
            <span class="chip">Total: ‚Çπ${money(invoice.totals?.total)}</span>
          </div>
        </div>
        
        <div class="row" style="margin-bottom:16px;gap:12px;">
          <button class="btn" id="switchToRefund" style="flex:1;background:var(--gradient-danger);">üí∞ Refund Mode</button>
          <button class="btn" id="switchToExchange" style="flex:1;background:var(--gradient-primary);">üîÑ Exchange Mode</button>
        </div>
        
        <div id="returnMode">
          <h4>Select Items to Return</h4>
          <div class="table-container" style="margin-top: 16px;">
            <table>
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Variant</th>
                  <th class="right">Price</th>
                  <th class="right">Qty</th>
                  <th class="right">Return Qty</th>
                  <th class="right">Return Value</th>
                </tr>
              </thead>
              <tbody id="returnItemsBody">
                ${(invoice.items || []).map((item, index) => {
                  const product = getProduct(item.productId);
                  return `
                    <tr>
                      <td><strong>${product?.name || 'N/A'}</strong></td>
                      <td>${item.size}/${item.color}</td>
                      <td class="right mono">‚Çπ${money(item.price)}</td>
                      <td class="right">${item.qty}</td>
                      <td class="right">
                        <input class="input return-qty-input" type="number" min="0" max="${item.qty}" value="0" 
                               style="width: 80px;" data-index="${index}" data-price="${item.price}">
                      </td>
                      <td class="right mono return-value" data-index="${index}">‚Çπ0.00</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
          
          <div style="background:var(--panel-2);padding:16px;border-radius:8px;margin-top:16px;">
            <div style="display:flex;justify-content:space-between;font-size:18px;font-weight:bold;">
              <span>Total Return Value:</span>
              <span id="totalReturnValue" class="mono" style="color:var(--danger);">‚Çπ0.00</span>
            </div>
          </div>
          
          <div class="row" style="margin-top: 16px;">
            <button class="btn red" id="processRefund">üí∞ Process Refund</button>
          </div>
        </div>
        
        <div id="exchangeMode" style="display:none;">
          <div class="grid">
            <div>
              <h4>Items to Return</h4>
              <div class="table-container" style="margin-top: 12px;">
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Variant</th>
                      <th class="right">Price</th>
                      <th class="right">Return Qty</th>
                    </tr>
                  </thead>
                  <tbody id="exchangeReturnBody">
                    ${(invoice.items || []).map((item, index) => {
                      const product = getProduct(item.productId);
                      return `
                        <tr>
                          <td>${product?.name || 'N/A'}</td>
                          <td>${item.size}/${item.color}</td>
                          <td class="right mono">‚Çπ${money(item.price)}</td>
                          <td class="right">
                            <input class="input exchange-return-qty" type="number" min="0" max="${item.qty}" 
                                   value="0" style="width: 70px;" data-index="${index}" 
                                   data-product-id="${item.productId}" data-price="${item.price}"
                                   data-size="${item.size}" data-color="${item.color}">
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
              <div style="background:var(--panel-2);padding:12px;border-radius:8px;margin-top:12px;">
                <div style="display:flex;justify-content:space-between;">
                  <span><strong>Return Value:</strong></span>
                  <span id="exchangeReturnValue" class="mono" style="color:var(--danger);font-weight:bold;">‚Çπ0.00</span>
                </div>
              </div>
            </div>
            
            <div>
              <h4>New Items (Exchange)</h4>
              <div style="margin-bottom:12px;">
                <input class="input" id="exchangeSearch" placeholder="Search product to add">
              </div>
              <div id="exchangeNewItems" style="max-height:300px;overflow-y:auto;">
                <!-- Exchange items will be added here -->
              </div>
              <div style="background:var(--panel-2);padding:12px;border-radius:8px;margin-top:12px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                  <span><strong>Exchange Value:</strong></span>
                  <span id="exchangeNewValue" class="mono" style="color:var(--good);font-weight:bold;">‚Çπ0.00</span>
                </div>
                <div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:8px;">
                  <span><strong>Difference:</strong></span>
                  <span id="exchangeDifference" class="mono" style="font-weight:bold;font-size:16px;">‚Çπ0.00</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row" style="margin-top: 16px;">
            <button class="btn green" id="processExchange">üîÑ Complete Exchange</button>
          </div>
        </div>
      `;

      const exchangeCart = [];
      
      // Update return values on input change
      $$('.return-qty-input').forEach(input => {
        input.oninput = () => {
          const index = input.dataset.index;
          const qty = parseFloat(input.value) || 0;
          const price = parseFloat(input.dataset.price) || 0;
          const value = qty * price;
          
          $(`.return-value[data-index="${index}"]`).textContent = '‚Çπ' + money(value);
          
          // Update total
          let total = 0;
          $$('.return-qty-input').forEach(inp => {
            const q = parseFloat(inp.value) || 0;
            const p = parseFloat(inp.dataset.price) || 0;
            total += q * p;
          });
          $('#totalReturnValue').textContent = '‚Çπ' + money(total);
        };
      });
      
      // Exchange mode calculations
      function updateExchangeValues() {
        let returnVal = 0;
        $$('.exchange-return-qty').forEach(inp => {
          const q = parseFloat(inp.value) || 0;
          const p = parseFloat(inp.dataset.price) || 0;
          returnVal += q * p;
        });
        
        let exchangeVal = 0;
        exchangeCart.forEach(item => {
          exchangeVal += item.price * item.qty;
        });
        
        const diff = exchangeVal - returnVal;
        
        $('#exchangeReturnValue').textContent = '‚Çπ' + money(returnVal);
        $('#exchangeNewValue').textContent = '‚Çπ' + money(exchangeVal);
        $('#exchangeDifference').textContent = (diff >= 0 ? '+' : '') + '‚Çπ' + money(diff);
        $('#exchangeDifference').style.color = diff > 0 ? 'var(--good)' : diff < 0 ? 'var(--danger)' : 'var(--muted)';
      }
      
      $$('.exchange-return-qty').forEach(input => {
        input.oninput = updateExchangeValues;
      });
      
      // Search products for exchange
      $('#exchangeSearch').oninput = () => {
        const query = $('#exchangeSearch').value.toLowerCase();
        if (query.length < 2) {
          $('#exchangeNewItems').innerHTML = '<div class="muted" style="padding:12px;">Type to search products...</div>';
          return;
        }
        
        const matches = db.products.filter(p => 
          p.name.toLowerCase().includes(query) || 
          (p.sku && p.sku.toLowerCase().includes(query))
        ).slice(0, 10);
        
        if (matches.length === 0) {
          $('#exchangeNewItems').innerHTML = '<div class="muted" style="padding:12px;">No products found.</div>';
          return;
        }
        
        $('#exchangeNewItems').innerHTML = matches.map(p => {
          const variants = p.variants && p.variants.length ? p.variants : [{size:'STD', color:'STD'}];
          return `
            <div class="card" style="margin-bottom:8px;padding:12px;">
              <div style="margin-bottom:8px;">
                <strong>${p.name}</strong>
                <span class="muted" style="font-size:12px;margin-left:8px;">${p.sku || ''}</span>
                <div class="mono" style="color:var(--good);font-weight:bold;">‚Çπ${money(p.price)}</div>
              </div>
              <div class="chips">
                ${variants.map(v => `
                  <button class="chip" style="cursor:pointer;" 
                          data-pid="${p.id}" data-name="${p.name}" data-price="${p.price}"
                          data-size="${v.size}" data-color="${v.color}">
                    ${v.size}/${v.color}
                  </button>
                `).join('')}
              </div>
            </div>
          `;
        }).join('');
        
        // Add click handlers to variant chips
        $('#exchangeNewItems').querySelectorAll('.chip').forEach(chip => {
          chip.onclick = () => {
            const item = {
              productId: chip.dataset.pid,
              name: chip.dataset.name,
              price: parseFloat(chip.dataset.price),
              size: chip.dataset.size,
              color: chip.dataset.color,
              qty: 1
            };
            
            // Check if already in cart
            const existing = exchangeCart.find(i => 
              i.productId === item.productId && 
              i.size === item.size && 
              i.color === item.color
            );
            
            if (existing) {
              existing.qty++;
            } else {
              exchangeCart.push(item);
            }
            
            renderExchangeCart();
            updateExchangeValues();
          };
        });
      };
      
      function renderExchangeCart() {
        if (exchangeCart.length === 0) {
          $('#exchangeNewItems').innerHTML = '<div class="muted" style="padding:12px;">Search and add products to exchange</div>';
          return;
        }
        
        $('#exchangeNewItems').innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Variant</th>
                  <th class="right">Price</th>
                  <th class="right">Qty</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${exchangeCart.map((item, idx) => `
                  <tr>
                    <td>${item.name}</td>
                    <td>${item.size}/${item.color}</td>
                    <td class="right mono">‚Çπ${money(item.price)}</td>
                    <td class="right">
                      <input class="input" type="number" min="1" value="${item.qty}" 
                             style="width:60px;" data-idx="${idx}">
                    </td>
                    <td class="right">
                      <button class="btn red" style="padding:4px 8px;font-size:12px;" data-idx="${idx}">√ó</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        // Qty change handlers
        $('#exchangeNewItems').querySelectorAll('input[type="number"]').forEach(inp => {
          inp.oninput = () => {
            const idx = parseInt(inp.dataset.idx);
            exchangeCart[idx].qty = parseInt(inp.value) || 1;
            updateExchangeValues();
          };
        });
        
        // Remove handlers
        $('#exchangeNewItems').querySelectorAll('button[data-idx]').forEach(btn => {
          btn.onclick = () => {
            exchangeCart.splice(parseInt(btn.dataset.idx), 1);
            renderExchangeCart();
            updateExchangeValues();
          };
        });
      }
      
      // Switch modes
      $('#switchToRefund').onclick = () => {
        $('#returnMode').style.display = 'block';
        $('#exchangeMode').style.display = 'none';
        $('#switchToRefund').style.opacity = '1';
        $('#switchToExchange').style.opacity = '0.6';
      };
      
      $('#switchToExchange').onclick = () => {
        $('#returnMode').style.display = 'none';
        $('#exchangeMode').style.display = 'block';
        $('#switchToRefund').style.opacity = '0.6';
        $('#switchToExchange').style.opacity = '1';
        renderExchangeCart();
      };

      // Process refund
      $('#processRefund').onclick = async () => {
        const returnItems = [];
        let refundAmount = 0;

        // Validate
        for (const [index, item] of (invoice.items || []).entries()) {
          const returnQty = +$(`.return-qty-input[data-index="${index}"]`).value;
          if (returnQty > item.qty) {
            alert(`Return quantity for ${getProduct(item.productId)?.name || 'item'} cannot exceed original quantity.`);
            return;
          }
        }
        
        // Process
        (invoice.items || []).forEach((item, index) => {
          const returnQty = +$(`.return-qty-input[data-index="${index}"]`).value;
          if (returnQty > 0) {
            returnItems.push({ ...item, qty: returnQty });
            refundAmount += item.price * returnQty;
            adjustStock(invoice.storeId, item.productId, item.size, item.color, returnQty);
          }
        });

        if (returnItems.length === 0) {
          return alert('Please select items to return.');
        }

        const refundInvoice = {
          id: uid(),
          date: today(),
          time: new Date().toLocaleTimeString(),
          storeId: invoice.storeId,
          number: `REF-${invoice.number}`,
          relatedInvoiceId: invoice.id,
          customerId: invoice.customerId,
          items: returnItems,
          returnValue: refundAmount,
          totals: { sub: -refundAmount, tax: 0, total: -refundAmount, round: 0 },
          payments: [{ mode: 'Refund', amount: -refundAmount, reference: '', timestamp: new Date().toISOString() }],
          notes: `Refund for invoice ${invoice.number}`
        };
        
        db.invoices.push(refundInvoice);
        await save();
        alert(`Refund of ‚Çπ${money(refundAmount)} processed successfully!`);
        renderReturns(root);
      };

      // Process exchange
      $('#processExchange').onclick = async () => {
        const returnItems = [];
        let returnValue = 0;

        // Validate returns
        (invoice.items || []).forEach((item, index) => {
          const returnQty = +$(`.exchange-return-qty[data-index="${index}"]`).value;
          if (returnQty > 0) {
            returnItems.push({ ...item, qty: returnQty });
            returnValue += item.price * returnQty;
            adjustStock(invoice.storeId, item.productId, item.size, item.color, returnQty);
          }
        });

        if (returnItems.length === 0) {
          return alert('Please select items to return.');
        }
        
        if (exchangeCart.length === 0) {
          return alert('Please add items for exchange.');
        }
        
        // Check stock availability
        for (const item of exchangeCart) {
          const available = stockQty(invoice.storeId, item.productId, item.size, item.color);
          if (item.qty > available) {
            return alert(`Insufficient stock for ${item.name} (${item.size}/${item.color}). Available: ${available}`);
          }
        }
        
        let exchangeValue = 0;
        exchangeCart.forEach(item => {
          exchangeValue += item.price * item.qty;
          adjustStock(invoice.storeId, item.productId, item.size, item.color, -item.qty);
        });
        
        const difference = exchangeValue - returnValue;
        
        // Create exchange invoice
        const exchangeInvoice = {
          id: uid(),
          date: today(),
          time: new Date().toLocaleTimeString(),
          storeId: invoice.storeId,
          number: `EXC-${invoice.number}-${uid().slice(0,4)}`,
          relatedInvoiceId: invoice.id,
          customerId: invoice.customerId,
          cashierId: currentUser ? currentUser.id : null,
          items: exchangeCart.map(item => ({
            productId: item.productId,
            size: item.size,
            color: item.color,
            qty: item.qty,
            price: item.price,
            taxPct: 0,
            discount: 0
          })),
          returnedItems: returnItems,
          returnValue: returnValue,
          exchangeValue: exchangeValue,
          totals: { sub: difference, tax: 0, total: difference, round: 0 },
          payments: difference > 0 ? [{ mode: 'Cash', amount: difference, reference: '', timestamp: new Date().toISOString() }] : 
                    difference < 0 ? [{ mode: 'Refund', amount: difference, reference: '', timestamp: new Date().toISOString() }] :
                    [{ mode: 'Exchange', amount: 0, reference: '', timestamp: new Date().toISOString() }],
          notes: `Exchange from invoice ${invoice.number}. Return value: ‚Çπ${money(returnValue)}, Exchange value: ‚Çπ${money(exchangeValue)}`
        };
        
        db.invoices.push(exchangeInvoice);
        await save();
        
        let message = `Exchange completed successfully!\n\n`;
        message += `Return Value: ‚Çπ${money(returnValue)}\n`;
        message += `Exchange Value: ‚Çπ${money(exchangeValue)}\n`;
        if (difference > 0) {
          message += `\nCustomer pays: ‚Çπ${money(difference)}`;
        } else if (difference < 0) {
          message += `\nRefund to customer: ‚Çπ${money(Math.abs(difference))}`;
        } else {
          message += `\nEven exchange (no payment required)`;
        }
        
        alert(message);
        renderReturns(root);
      };
      
    } else if (invoice) {
      detailsContainer.innerHTML = '<div class="muted">This is a refund/exchange invoice. Please enter an original sales invoice number.</div>';
    } else {
      detailsContainer.innerHTML = '<div class="muted">Invoice not found.</div>';
    }
  };
  
  // View transaction details
  $$('button[data-id]').forEach(btn => {
    btn.onclick = () => {
      const invId = btn.dataset.id;
      const inv = db.invoices.find(i => i.id === invId);
      if (inv) {
        printInvoice(inv);
      }
    };
  });
}


/* ====== Customers ====== */
function renderCustomers(root){
  root.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>New Customer</h3>
        <div class="section stack">
          <input class="input" id="cName" placeholder="Name">
          <div class="row">
            <input class="input" id="cPhone" placeholder="Phone">
            <input class="input" id="cGSTIN" placeholder="GSTIN (optional)">
          </div>
          <textarea class="input" id="cAddr" rows="3" placeholder="Address"></textarea>
          <div class="row"><button class="btn" id="cAdd">Save</button></div>
        </div>
      </div>
      <div class="card">
        <h3>Customers</h3>
        <div class="section">
          <div class="table-container"><table><thead><tr><th>Name</th><th>Phone</th><th>GSTIN</th><th>Address</th><th></th></tr></thead>
          <tbody id="cBody"></tbody></table></div>
        </div>
      </div>
    </div>
  `;
  $('#cAdd').onclick=async ()=>{
    const c={id:uid(),name:$('#cName').value.trim(),phone:$('#cPhone').value.trim(),gstin:$('#cGSTIN').value.trim(),address:$('#cAddr').value.trim()};
    if(!c.name) return alert('Name required');
    db.customers.push(c); await save(); renderCustomers(root);
  };
  const body=$('#cBody');
  body.innerHTML = db.customers.map(c=>`
    <tr><td>${c.name}</td><td>${c.phone||''}</td><td>${c.gstin||''}</td><td>${c.address||''}</td>
    <td class="right"><button class="btn red" data-id="${c.id}">Delete</button></td></tr>
  `).join('') || `<tr><td colspan="5" class="muted">No customers.</td></tr>`;
  body.querySelectorAll('.btn.red').forEach(b=>{
    b.onclick=async ()=>{ const id=b.dataset.id; if(confirm('Delete customer?')){ db.customers=db.customers.filter(x=>x.id!==id); await save(); renderCustomers(root);} };
  });
}

/* ====== Reports ====== */
function renderReports(root){
  // Calculate analytics data
  const salesInvoices = db.invoices.filter(inv => !inv.number?.startsWith('REF-'));
  
  // Daily sales
  const daily = {};
  salesInvoices.forEach(inv=>{
    daily[inv.date] = (daily[inv.date]||0) + (inv.totals?.total||0);
  });
  
  // Hourly sales (last 24 hours)
  const hourly = Array(24).fill(0);
  const todayDate = new Date().toISOString().slice(0,10);
  salesInvoices.filter(inv => inv.date === todayDate).forEach(inv => {
    if (inv.time) {
      const hour = parseInt(inv.time.split(':')[0]);
      if (!isNaN(hour)) hourly[hour] += inv.totals?.total || 0;
    }
  });
  
  // Top selling products
  const productSales = {};
  salesInvoices.forEach(inv => {
    (inv.items || []).forEach(item => {
      const key = item.productId;
      if (!productSales[key]) {
        productSales[key] = {qty: 0, revenue: 0, profit: 0};
      }
      productSales[key].qty += item.qty || 0;
      const itemTotal = (item.price * item.qty) * (1 - (item.discount || 0) / 100);
      productSales[key].revenue += itemTotal;
      
      // Calculate profit (need cost from purchases)
      const product = getProduct(item.productId);
      if (product) {
        const purchases = db.purchases.filter(p => 
          p.items.some(pi => pi.productId === item.productId)
        );
        let avgCost = 0;
        if (purchases.length > 0) {
          const totalCost = purchases.reduce((sum, p) => {
            const purchaseItem = p.items.find(pi => pi.productId === item.productId);
            return sum + (purchaseItem?.cost || 0);
          }, 0);
          avgCost = totalCost / purchases.length;
        }
        productSales[key].profit += itemTotal - (avgCost * item.qty);
      }
    });
  });
  
  const topProducts = Object.entries(productSales)
    .map(([id, data]) => ({product: getProduct(id), ...data}))
    .filter(x => x.product)
    .sort((a, b) => b.revenue - a.revenue)
    .slice(0, 10);
  
  // Category sales
  const categorySales = {};
  salesInvoices.forEach(inv => {
    (inv.items || []).forEach(item => {
      const product = getProduct(item.productId);
      const category = product?.category || 'Uncategorized';
      if (!categorySales[category]) categorySales[category] = 0;
      const itemTotal = (item.price * item.qty) * (1 - (item.discount || 0) / 100);
      categorySales[category] += itemTotal;
    });
  });
  
  // Store comparison
  const storeSales = {};
  db.stores.forEach(s => storeSales[s.id] = {name: s.name, revenue: 0, orders: 0});
  salesInvoices.forEach(inv => {
    if (storeSales[inv.storeId]) {
      storeSales[inv.storeId].revenue += inv.totals?.total || 0;
      storeSales[inv.storeId].orders++;
    }
  });
  
  // Cashier performance
  const cashierPerf = {};
  salesInvoices.forEach(inv => {
    const cashier = inv.cashierId || inv.userId || 'Unknown';
    if (!cashierPerf[cashier]) {
      const user = db.users.find(u => u.id === cashier);
      cashierPerf[cashier] = {
        name: user?.name || 'System',
        orders: 0,
        revenue: 0,
        avgOrder: 0
      };
    }
    cashierPerf[cashier].orders++;
    cashierPerf[cashier].revenue += inv.totals?.total || 0;
  });
  Object.values(cashierPerf).forEach(c => {
    c.avgOrder = c.orders > 0 ? c.revenue / c.orders : 0;
  });
  
  // Stock valuation
  const valuation = db.stock.reduce((a,s)=>{
    const p=getProduct(s.productId)||{};
    return a + (p.price||0)*(s.qty||0);
  },0);
  
  // Total metrics
  const totalRevenue = salesInvoices.reduce((sum, inv) => sum + (inv.totals?.total || 0), 0);
  const totalOrders = salesInvoices.length;
  const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

  root.innerHTML = `
    <div class="stack">
      <!-- Key Metrics -->
      <div class="totals" style="grid-template-columns: repeat(4, 1fr);">
        <div class="kpi">
          <h4>Total Revenue</h4>
          <div class="val mono">‚Çπ${money(totalRevenue)}</div>
        </div>
        <div class="kpi">
          <h4>Total Orders</h4>
          <div class="val">${totalOrders}</div>
        </div>
        <div class="kpi">
          <h4>Avg Order Value</h4>
          <div class="val mono">‚Çπ${money(avgOrderValue)}</div>
        </div>
        <div class="kpi">
          <h4>Stock Value</h4>
          <div class="val mono">‚Çπ${money(valuation)}</div>
        </div>
      </div>

      <!-- Sales Trends -->
      <div class="grid">
        <div class="card">
          <h3>üìà Daily Sales Trend (Last 30 Days)</h3>
          <div class="section">
            <div class="table-container">
            ${Object.keys(daily).length? '<table><thead><tr><th>Date</th><th class="right">Revenue</th></tr></thead><tbody>'+
              Object.entries(daily).sort((a,b)=>b[0].localeCompare(a[0])).slice(0, 30).map(([d,v])=>`<tr><td>${d}</td><td class="right mono">‚Çπ ${money(v)}</td></tr>`).join('')+
            '</tbody></table>' : '<div class="muted">No sales yet.</div>'}
            </div>
          </div>
        </div>
        
        <div class="card">
          <h3>‚è∞ Hourly Sales (Today)</h3>
          <div class="section">
            <div style="padding:16px;">
              ${hourly.map((amt, hr) => {
                const maxHourly = Math.max(...hourly, 1);
                const widthPct = (amt / maxHourly) * 100;
                return `
                  <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                    <span style="min-width:60px;font-size:13px;">${hr}:00</span>
                    <div style="flex:1;background:var(--panel-2);border-radius:4px;height:24px;position:relative;overflow:hidden;">
                      <div style="width:${widthPct}%;height:100%;background:var(--gradient-primary);transition:width 0.3s;"></div>
                    </div>
                    <span style="min-width:80px;text-align:right;font-size:13px;font-family:monospace;">‚Çπ${money(amt)}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      </div>

      <!-- Top Products & Category Analysis -->
      <div class="grid">
        <div class="card">
          <h3>üèÜ Top Selling Products</h3>
          <div class="section">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="right">Qty Sold</th>
                    <th class="right">Revenue</th>
                    <th class="right">Profit</th>
                    <th class="right">Margin %</th>
                  </tr>
                </thead>
                <tbody>
                  ${topProducts.map(item => {
                    const marginPct = item.revenue > 0 ? (item.profit / item.revenue) * 100 : 0;
                    return `
                      <tr>
                        <td><strong>${item.product.name}</strong><br><span class="muted" style="font-size:12px;">${item.product.category || 'N/A'}</span></td>
                        <td class="right">${item.qty}</td>
                        <td class="right mono">‚Çπ${money(item.revenue)}</td>
                        <td class="right mono" style="color:${item.profit >= 0 ? 'var(--good)' : 'var(--danger)'}">‚Çπ${money(item.profit)}</td>
                        <td class="right" style="color:${marginPct >= 30 ? 'var(--good)' : marginPct >= 15 ? 'var(--warn)' : 'var(--danger)'}">
                          ${marginPct.toFixed(1)}%
                        </td>
                      </tr>
                    `;
                  }).join('') || '<tr><td colspan="5" class="muted">No sales data available.</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üì¶ Sales by Category</h3>
          <div class="section">
            <div style="padding:16px;">
              ${Object.entries(categorySales).sort((a,b) => b[1] - a[1]).map(([cat, amt]) => {
                const maxCat = Math.max(...Object.values(categorySales), 1);
                const widthPct = (amt / maxCat) * 100;
                return `
                  <div style="margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                      <span style="font-weight:600;">${cat}</span>
                      <span style="font-family:monospace;color:var(--muted);">‚Çπ${money(amt)}</span>
                    </div>
                    <div style="background:var(--panel-2);border-radius:4px;height:20px;position:relative;overflow:hidden;">
                      <div style="width:${widthPct}%;height:100%;background:var(--gradient-success);transition:width 0.3s;"></div>
                    </div>
                  </div>
                `;
              }).join('') || '<div class="muted">No category data.</div>'}
            </div>
          </div>
        </div>
      </div>

      <!-- Store Comparison -->
      <div class="card">
        <h3>üè™ Store Performance Comparison</h3>
        <div class="section">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Store</th>
                  <th class="right">Total Orders</th>
                  <th class="right">Total Revenue</th>
                  <th class="right">Avg Order Value</th>
                  <th class="right">Performance</th>
                </tr>
              </thead>
              <tbody>
                ${Object.values(storeSales).sort((a,b) => b.revenue - a.revenue).map(store => {
                  const avgOrder = store.orders > 0 ? store.revenue / store.orders : 0;
                  const maxRevenue = Math.max(...Object.values(storeSales).map(s => s.revenue), 1);
                  const perfPct = (store.revenue / maxRevenue) * 100;
                  return `
                    <tr>
                      <td><strong>${store.name}</strong></td>
                      <td class="right">${store.orders}</td>
                      <td class="right mono">‚Çπ${money(store.revenue)}</td>
                      <td class="right mono">‚Çπ${money(avgOrder)}</td>
                      <td class="right">
                        <div style="display:inline-block;width:100px;background:var(--panel-2);border-radius:4px;height:20px;position:relative;overflow:hidden;">
                          <div style="width:${perfPct}%;height:100%;background:var(--gradient-primary);"></div>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="5" class="muted">No store data available.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Cashier Performance -->
      <div class="card">
        <h3>üë§ Cashier Performance Metrics</h3>
        <div class="section">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Cashier</th>
                  <th class="right">Total Orders</th>
                  <th class="right">Total Revenue</th>
                  <th class="right">Avg Order Value</th>
                  <th class="right">Performance</th>
                </tr>
              </thead>
              <tbody>
                ${Object.values(cashierPerf).sort((a,b) => b.revenue - a.revenue).map(cashier => {
                  const maxRevenue = Math.max(...Object.values(cashierPerf).map(c => c.revenue), 1);
                  const perfPct = (cashier.revenue / maxRevenue) * 100;
                  return `
                    <tr>
                      <td><strong>${cashier.name}</strong></td>
                      <td class="right">${cashier.orders}</td>
                      <td class="right mono">‚Çπ${money(cashier.revenue)}</td>
                      <td class="right mono">‚Çπ${money(cashier.avgOrder)}</td>
                      <td class="right">
                        <div style="display:inline-block;width:100px;background:var(--panel-2);border-radius:4px;height:20px;position:relative;overflow:hidden;">
                          <div style="width:${perfPct}%;height:100%;background:var(--gradient-success);"></div>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="5" class="muted">No cashier data available.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Payment Method Analysis -->
      <div class="grid">
        <div class="card">
          <h3>üí≥ Payment Method Breakdown</h3>
          <div class="section">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Payment Method</th>
                    <th class="right">Transactions</th>
                    <th class="right">Total Amount</th>
                    <th class="right">Avg Transaction</th>
                    <th class="right">% of Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${(() => {
                    const paymentStats = {};
                    let grandTotal = 0;
                    
                    salesInvoices.forEach(inv => {
                      const payments = Array.isArray(inv.payments) ? inv.payments : [inv.payments];
                      payments.forEach(p => {
                        const mode = p.mode || 'Cash';
                        if (!paymentStats[mode]) {
                          paymentStats[mode] = { count: 0, total: 0 };
                        }
                        paymentStats[mode].count++;
                        paymentStats[mode].total += p.amount || 0;
                        grandTotal += p.amount || 0;
                      });
                    });
                    
                    const paymentMethods = {
                      'Cash': { icon: 'üíµ', color: 'var(--good)' },
                      'Card': { icon: 'üí≥', color: 'var(--accent)' },
                      'UPI': { icon: 'üì±', color: 'var(--accent-2)' },
                      'Wallet': { icon: 'üëõ', color: 'var(--warn)' },
                      'Credit': { icon: 'üè¶', color: 'var(--muted)' }
                    };
                    
                    return Object.entries(paymentStats)
                      .sort((a, b) => b[1].total - a[1].total)
                      .map(([mode, stats]) => {
                        const avgTxn = stats.count > 0 ? stats.total / stats.count : 0;
                        const percentage = grandTotal > 0 ? (stats.total / grandTotal) * 100 : 0;
                        const methodInfo = paymentMethods[mode] || { icon: 'üí∞', color: 'var(--muted)' };
                        
                        return `
                          <tr>
                            <td><strong>${methodInfo.icon} ${mode}</strong></td>
                            <td class="right">${stats.count}</td>
                            <td class="right mono" style="color:${methodInfo.color};font-weight:bold;">‚Çπ${money(stats.total)}</td>
                            <td class="right mono">‚Çπ${money(avgTxn)}</td>
                            <td class="right">
                              <div style="display:inline-flex;align-items:center;gap:8px;">
                                <div style="width:100px;background:var(--panel-2);border-radius:4px;height:20px;position:relative;overflow:hidden;">
                                  <div style="width:${percentage}%;height:100%;background:${methodInfo.color};"></div>
                                </div>
                                <span style="font-weight:bold;min-width:45px;">${percentage.toFixed(1)}%</span>
                              </div>
                            </td>
                          </tr>
                        `;
                      }).join('') || '<tr><td colspan="5" class="muted">No payment data available.</td></tr>';
                  })()}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üí∞ Daily Cash Reconciliation</h3>
          <div class="section">
            <div style="padding:16px;">
              ${(() => {
                const dailyCash = {};
                
                salesInvoices.forEach(inv => {
                  const payments = Array.isArray(inv.payments) ? inv.payments : [inv.payments];
                  payments.forEach(p => {
                    if (p.mode === 'Cash') {
                      const date = inv.date;
                      if (!dailyCash[date]) dailyCash[date] = 0;
                      dailyCash[date] += p.amount || 0;
                    }
                  });
                });
                
                const last7Days = Object.entries(dailyCash)
                  .sort((a, b) => b[0].localeCompare(a[0]))
                  .slice(0, 7);
                
                if (last7Days.length === 0) {
                  return '<div class="muted">No cash transactions yet.</div>';
                }
                
                const maxCash = Math.max(...last7Days.map(([, amt]) => amt), 1);
                
                return last7Days.map(([date, amount]) => {
                  const widthPct = (amount / maxCash) * 100;
                  const isToday = date === today();
                  return `
                    <div style="margin-bottom:16px;">
                      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                        <span style="font-weight:${isToday ? 'bold' : '500'};">${date}${isToday ? ' (Today)' : ''}</span>
                        <span style="font-family:monospace;color:var(--good);font-weight:bold;">‚Çπ${money(amount)}</span>
                      </div>
                      <div style="background:var(--panel-2);border-radius:4px;height:24px;position:relative;overflow:hidden;">
                        <div style="width:${widthPct}%;height:100%;background:var(--gradient-success);transition:width 0.3s;"></div>
                      </div>
                    </div>
                  `;
                }).join('');
              })()}
            </div>
            <div style="padding:0 16px 16px 16px;">
              <button class="btn green" id="exportCashReport" style="width:100%;">üìä Export Cash Report</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Split Payment Analysis -->
      <div class="card">
        <h3>üîÄ Split Payment Transactions</h3>
        <div class="section">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Invoice #</th>
                  <th>Customer</th>
                  <th class="right">Total Amount</th>
                  <th>Payment Methods</th>
                  <th>Split Details</th>
                </tr>
              </thead>
              <tbody>
                ${salesInvoices
                  .filter(inv => Array.isArray(inv.payments) && inv.payments.length > 1)
                  .sort((a, b) => b.date.localeCompare(a.date))
                  .slice(0, 20)
                  .map(inv => {
                    const customer = inv.customerId ? db.customers.find(c => c.id === inv.customerId) : null;
                    const paymentModes = inv.payments.map(p => p.mode).join(', ');
                    const paymentDetails = inv.payments.map(p => `${p.mode}: ‚Çπ${money(p.amount)}`).join(' + ');
                    
                    return `
                      <tr>
                        <td>${inv.date}</td>
                        <td><strong>${inv.number}</strong></td>
                        <td>${customer ? customer.name : 'Walk-in'}</td>
                        <td class="right mono">‚Çπ${money(inv.totals?.total)}</td>
                        <td><span class="badge" style="background:var(--warn)">${inv.payments.length} methods</span></td>
                        <td class="muted" style="font-size:12px;">${paymentDetails}</td>
                      </tr>
                    `;
                  }).join('') || '<tr><td colspan="6" class="muted" style="text-align:center;">No split payment transactions found.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Invoice History -->
      <div class="card">
        <h3>üìÑ Invoice History</h3>
        <div class="section">
          <div class="row">
            <input class="input" id="repInvSearch" placeholder="Search by Invoice #, Customer Name, or Phone">
            <button class="btn" id="repInvFind">Search</button>
          </div>
        </div>
        <div class="section">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date & Time</th>
                  <th>Invoice #</th>
                  <th>Customer</th>
                  <th>Store</th>
                  <th class="right">Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="repInvBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;

  const fillInvoices = () => {
    const q = ($('#repInvSearch').value || '').toLowerCase();
    const invoiceBody = $('#repInvBody');
    
    const reversedInvoices = [...db.invoices].reverse();
    let invoicesToShow;

    if (q) {
      invoicesToShow = reversedInvoices.filter(inv => {
        const cust = inv.customerId ? db.customers.find(c => c.id === inv.customerId) : null;
        return (
          (inv.number || '').toLowerCase().includes(q) ||
          (cust && cust.name.toLowerCase().includes(q)) ||
          (cust && cust.phone && cust.phone.includes(q))
        );
      });
    } else {
      invoicesToShow = reversedInvoices.slice(0, 50);
    }

    invoiceBody.innerHTML = invoicesToShow.map(inv => {
      const store = getStore(inv.storeId);
      const cust = inv.customerId ? db.customers.find(c => c.id === inv.customerId) : null;
      return `
        <tr>
          <td>${inv.date} ${inv.time || ''}</td>
          <td>${inv.number}</td>
          <td>${cust ? cust.name : 'Walk-in'}</td>
          <td>${store ? store.name : 'N/A'}</td>
          <td class="right mono">‚Çπ${money(inv.totals?.total)}</td>
          <td class="right">
            <button class="btn" data-id="${inv.id}">Re-print</button>
          </td>
        </tr>
      `;
    }).join('') || `<tr><td colspan="6" class="muted">No invoices found.</td></tr>`;

    invoiceBody.querySelectorAll('button').forEach(btn => {
      btn.onclick = () => {
        const invoiceId = btn.dataset.id;
        const invoice = db.invoices.find(inv => inv.id === invoiceId);
        if (invoice) {
          printInvoice(invoice);
        }
      };
    });
  };

  $('#repInvFind').onclick = fillInvoices;
  $('#repInvSearch').onkeydown = (e) => { if (e.key === 'Enter') fillInvoices(); };
  fillInvoices(); // initial fill
  
  // Export cash report functionality
  const exportBtn = $('#exportCashReport');
  if (exportBtn) {
    exportBtn.onclick = () => {
      const dailyCash = {};
      const cashTransactions = [];
      
      salesInvoices.forEach(inv => {
        const payments = Array.isArray(inv.payments) ? inv.payments : [inv.payments];
        payments.forEach(p => {
          if (p.mode === 'Cash') {
            const date = inv.date;
            if (!dailyCash[date]) dailyCash[date] = 0;
            dailyCash[date] += p.amount || 0;
            
            cashTransactions.push({
              date: inv.date,
              time: inv.time,
              invoice: inv.number,
              amount: p.amount,
              store: getStore(inv.storeId)?.name || 'N/A'
            });
          }
        });
      });
      
      // Create CSV content
      let csv = 'Cash Reconciliation Report\\n\\n';
      csv += 'Daily Summary\\n';
      csv += 'Date,Cash Amount\\n';
      Object.entries(dailyCash)
        .sort((a, b) => b[0].localeCompare(a[0]))
        .forEach(([date, amount]) => {
          csv += `${date},${amount.toFixed(2)}\\n`;
        });
      
      csv += '\\n\\nDetailed Transactions\\n';
      csv += 'Date,Time,Invoice,Amount,Store\\n';
      cashTransactions
        .sort((a, b) => b.date.localeCompare(a.date))
        .forEach(txn => {
          csv += `${txn.date},${txn.time},${txn.invoice},${txn.amount.toFixed(2)},${txn.store}\\n`;
        });
      
      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cash-report-${today()}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      alert('Cash report exported successfully!');
    };
  }
}

/* ====== Low Stock Alerts & Auto-Reorder ====== */
function renderAlerts(root){
  const activeAlerts = db.alerts.filter(a => a.status === 'active');
  const resolvedAlerts = db.alerts.filter(a => a.status === 'resolved').slice(0, 20);
  
  root.innerHTML = `
    <div class="stack">
      <!-- Alert Summary -->
      <div class="totals" style="grid-template-columns: repeat(3, 1fr);">
        <div class="kpi">
          <h4>üîî Active Alerts</h4>
          <div class="val" style="color:var(--danger)">${activeAlerts.length}</div>
        </div>
        <div class="kpi">
          <h4>üì¶ Reorder Suggestions</h4>
          <div class="val">${db.reorderSuggestions.filter(r => r.status === 'pending').length}</div>
        </div>
        <div class="kpi">
          <h4>‚úÖ Resolved Today</h4>
          <div class="val">${db.alerts.filter(a => a.resolvedAt?.startsWith(today())).length}</div>
        </div>
      </div>

      <!-- Active Low Stock Alerts -->
      <div class="card">
        <h3>üî¥ Active Low Stock Alerts</h3>
        <div class="section">
          <div class="row" style="margin-bottom:16px;">
            <button class="btn warn" id="checkAllStock">üîç Check All Stock Levels</button>
            <button class="btn green" id="generateBulkPO">üì• Generate Bulk Purchase Order</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Store</th>
                  <th>Product</th>
                  <th>Variant</th>
                  <th class="right">Current</th>
                  <th class="right">Min</th>
                  <th class="right">Velocity/Day</th>
                  <th class="right">Suggested Order</th>
                  <th>Created</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="activeAlertsBody">
                ${activeAlerts.map(alert => {
                  const store = getStore(alert.storeId);
                  const product = getProduct(alert.productId);
                  const suggestion = db.reorderSuggestions.find(s => s.alertId === alert.id && s.status === 'pending');
                  return `
                    <tr>
                      <td><span class="status out">CRITICAL</span></td>
                      <td>${store?.name || 'N/A'}</td>
                      <td><strong>${product?.name || 'N/A'}</strong><br><span class="muted" style="font-size:11px;">${product?.sku || ''}</span></td>
                      <td>${alert.size}/${alert.color}</td>
                      <td class="right" style="color:var(--danger);font-weight:bold;">${alert.currentQty}</td>
                      <td class="right">${alert.minQty}</td>
                      <td class="right mono">${alert.salesVelocity}</td>
                      <td class="right" style="color:var(--good);font-weight:bold;">${alert.reorderQty}</td>
                      <td class="muted" style="font-size:12px;">${new Date(alert.createdAt).toLocaleString()}</td>
                      <td class="right">
                        <button class="btn green" data-alert-id="${alert.id}" data-action="create-po">Create PO</button>
                        <button class="btn secondary" data-alert-id="${alert.id}" data-action="dismiss">Dismiss</button>
                      </td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="10" class="muted" style="text-align:center;padding:20px;">‚úÖ No active alerts. All stock levels are healthy!</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Reorder Suggestions -->
      <div class="card">
        <h3>üìã Smart Reorder Suggestions</h3>
        <div class="section">
          <p class="muted" style="margin-bottom:16px;">Based on sales velocity analysis (last 30 days), here are suggested reorder quantities to maintain 30-day stock levels.</p>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Store</th>
                  <th>Product</th>
                  <th>Variant</th>
                  <th class="right">Current Stock</th>
                  <th class="right">Suggested Qty</th>
                  <th class="right">Estimated Cost</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${db.reorderSuggestions.filter(s => s.status === 'pending').map(suggestion => {
                  const store = getStore(suggestion.storeId);
                  const product = getProduct(suggestion.productId);
                  const stockItem = db.stock.find(s => 
                    s.storeId === suggestion.storeId && 
                    s.productId === suggestion.productId && 
                    s.size === suggestion.size && 
                    s.color === suggestion.color
                  );
                  
                  // Estimate cost from recent purchases
                  let estimatedCost = 0;
                  const recentPurchases = db.purchases.filter(p => 
                    p.items.some(i => i.productId === suggestion.productId)
                  ).slice(-3);
                  
                  if (recentPurchases.length > 0) {
                    const costs = recentPurchases.map(p => {
                      const item = p.items.find(i => i.productId === suggestion.productId);
                      return item?.cost || 0;
                    });
                    const avgCost = costs.reduce((a,b) => a+b, 0) / costs.length;
                    estimatedCost = avgCost * suggestion.suggestedQty;
                  }
                  
                  return `
                    <tr>
                      <td>${store?.name || 'N/A'}</td>
                      <td><strong>${product?.name || 'N/A'}</strong></td>
                      <td>${suggestion.size}/${suggestion.color}</td>
                      <td class="right">${stockItem?.qty || 0}</td>
                      <td class="right" style="font-weight:bold;color:var(--accent)">${suggestion.suggestedQty}</td>
                      <td class="right mono">${estimatedCost > 0 ? '‚Çπ' + money(estimatedCost) : 'N/A'}</td>
                      <td><span class="badge" style="background:var(--warn)">${suggestion.status}</span></td>
                      <td class="right">
                        <button class="btn green" data-suggestion-id="${suggestion.id}" data-action="approve">‚úì Approve</button>
                        <button class="btn red" data-suggestion-id="${suggestion.id}" data-action="reject">‚úó Reject</button>
                      </td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="8" class="muted" style="text-align:center;">No pending reorder suggestions.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Recently Resolved Alerts -->
      <div class="card">
        <h3>‚úÖ Recently Resolved Alerts</h3>
        <div class="section">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Store</th>
                  <th>Product</th>
                  <th>Variant</th>
                  <th>Resolved At</th>
                  <th>Action Taken</th>
                  <th>Resolved By</th>
                </tr>
              </thead>
              <tbody>
                ${resolvedAlerts.map(alert => {
                  const store = getStore(alert.storeId);
                  const product = getProduct(alert.productId);
                  const resolvedBy = alert.resolvedBy ? db.users.find(u => u.id === alert.resolvedBy) : null;
                  return `
                    <tr>
                      <td>${store?.name || 'N/A'}</td>
                      <td>${product?.name || 'N/A'}</td>
                      <td>${alert.size}/${alert.color}</td>
                      <td class="muted">${alert.resolvedAt ? new Date(alert.resolvedAt).toLocaleString() : 'N/A'}</td>
                      <td><span class="badge" style="background:var(--good)">${alert.action || 'Resolved'}</span></td>
                      <td>${resolvedBy?.name || 'System'}</td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="6" class="muted" style="text-align:center;">No resolved alerts yet.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;

  // Check all stock levels button
  $('#checkAllStock').onclick = async () => {
    let alertCount = 0;
    db.stock.forEach(stockItem => {
      if (stockItem.min > 0 && stockItem.qty <= stockItem.min) {
        // Check if alert doesn't already exist
        const alertKey = `${stockItem.storeId}-${stockItem.productId}-${stockItem.size}-${stockItem.color}`;
        const exists = db.alerts.find(a => a.key === alertKey && a.status === 'active');
        if (!exists) {
          checkLowStock(stockItem.storeId, stockItem.productId, stockItem.size, stockItem.color);
          alertCount++;
        }
      }
    });
    await save();
    renderTabs(); // Update notification badge
    alert(`Stock check complete. ${alertCount} new alert(s) generated.`);
    renderAlerts(root);
  };

  // Generate bulk purchase order
  $('#generateBulkPO').onclick = () => {
    if (activeAlerts.length === 0) {
      alert('No active alerts to create purchase orders from.');
      return;
    }
    
    // Group by store
    const storeGroups = {};
    activeAlerts.forEach(alert => {
      if (!storeGroups[alert.storeId]) {
        storeGroups[alert.storeId] = [];
      }
      storeGroups[alert.storeId].push(alert);
    });
    
    // Navigate to purchase page with pre-filled data
    localStorage.setItem('bulkPOData', JSON.stringify(storeGroups));
    alert(`Bulk purchase order data prepared for ${Object.keys(storeGroups).length} store(s). Opening Purchase page...`);
    open('purchase');
  };

  // Create individual PO buttons
  $$('button[data-action="create-po"]').forEach(btn => {
    btn.onclick = async () => {
      const alertId = btn.dataset.alertId;
      const alert = db.alerts.find(a => a.id === alertId);
      if (!alert) return;
      
      // Store data for purchase page
      localStorage.setItem('singlePOData', JSON.stringify(alert));
      alert('Purchase order data prepared. Opening Purchase page...');
      open('purchase');
    };
  });

  // Dismiss alert buttons
  $$('button[data-action="dismiss"]').forEach(btn => {
    btn.onclick = async () => {
      const alertId = btn.dataset.alertId;
      const alert = db.alerts.find(a => a.id === alertId);
      if (!alert) return;
      
      if (confirm('Are you sure you want to dismiss this alert? The stock is still low.')) {
        alert.status = 'resolved';
        alert.action = 'Dismissed';
        alert.resolvedAt = new Date().toISOString();
        alert.resolvedBy = currentUser ? currentUser.id : null;
        
        // Update related suggestion
        const suggestion = db.reorderSuggestions.find(s => s.alertId === alertId);
        if (suggestion) suggestion.status = 'dismissed';
        
        await save();
        renderTabs(); // Update notification badge
        renderAlerts(root);
      }
    };
  });

  // Approve suggestion buttons
  $$('button[data-action="approve"]').forEach(btn => {
    btn.onclick = async () => {
      const suggestionId = btn.dataset.suggestionId;
      const suggestion = db.reorderSuggestions.find(s => s.id === suggestionId);
      if (!suggestion) return;
      
      suggestion.status = 'approved';
      suggestion.approvedAt = new Date().toISOString();
      suggestion.approvedBy = currentUser ? currentUser.id : null;
      
      // Store for purchase page
      localStorage.setItem('singlePOData', JSON.stringify(suggestion));
      await save();
      alert('Reorder approved! Opening Purchase page to create purchase order...');
      open('purchase');
    };
  });

  // Reject suggestion buttons
  $$('button[data-action="reject"]').forEach(btn => {
    btn.onclick = async () => {
      const suggestionId = btn.dataset.suggestionId;
      const suggestion = db.reorderSuggestions.find(s => s.id === suggestionId);
      if (!suggestion) return;
      
      if (confirm('Reject this reorder suggestion?')) {
        suggestion.status = 'rejected';
        suggestion.rejectedAt = new Date().toISOString();
        suggestion.rejectedBy = currentUser ? currentUser.id : null;
        
        // Resolve related alert
        const alert = db.alerts.find(a => a.id === suggestion.alertId);
        if (alert) {
          alert.status = 'resolved';
          alert.action = 'Suggestion Rejected';
          alert.resolvedAt = new Date().toISOString();
          alert.resolvedBy = currentUser ? currentUser.id : null;
        }
        
        await save();
        renderTabs(); // Update notification badge
        renderAlerts(root);
      }
    };
  });
}

/* ====== User Management ====== */
function renderUsers(root){
  root.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Add / Edit User</h3>
        <div class="section stack">
          <input id="userName" class="input" placeholder="Full Name">
          <input id="userEmail" class="input" type="email" placeholder="Email Address">
          <input id="userPhone" class="input" placeholder="Phone Number">
          <select id="userRole" class="select">
            <option value="">Select Role</option>
            <option value="admin">Admin (Full Access)</option>
            <option value="manager">Manager (Store Management)</option>
            <option value="cashier">Cashier (POS Only)</option>
            <option value="stockkeeper">Stock Keeper (Inventory Only)</option>
          </select>
          <input id="userPassword" class="input" type="password" placeholder="Password (leave empty to keep current)">
          <div class="row">
            <select id="userStore" class="select">
              <option value="">Assign Store (Optional)</option>
              ${db.stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
            </select>
            <select id="userStatus" class="select">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="row">
            <button class="btn" id="userAdd">Save User</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>User Management</h3>
        <div class="section">
          <div class="row" style="margin-bottom:16px">
            <input class="input" id="userSearch" placeholder="Search users by name, email, or role">
            <button class="btn" id="userRefresh">Refresh</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Store</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="userBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:24px">
      <h3>Role Permissions</h3>
      <div class="section">
        <div class="stack">
          <div class="row">
            <div class="kpi" style="flex:1">
              <h4>Admin</h4>
              <p class="muted" style="font-size:14px">Full access to all features, user management, settings, and reports</p>
            </div>
            <div class="kpi" style="flex:1">
              <h4>Manager</h4>
              <p class="muted" style="font-size:14px">Store management, inventory, purchases, transfers, and reports</p>
            </div>
          </div>
          <div class="row">
            <div class="kpi" style="flex:1">
              <h4>Cashier</h4>
              <p class="muted" style="font-size:14px">POS billing, returns, and customer management only</p>
            </div>
            <div class="kpi" style="flex:1">
              <h4>Stock Keeper</h4>
              <p class="muted" style="font-size:14px">Inventory management, stock updates, and purchase entries</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  let editingUserId = null;
  
  function fillUsers() {
    const query = ($('#userSearch').value || '').toLowerCase();
    const body = $('#userBody');
    const filteredUsers = db.users.filter(u => {
      const searchText = [u.name, u.email, u.role, u.phone].filter(Boolean).join(' ').toLowerCase();
      return searchText.includes(query);
    });
    
    body.innerHTML = filteredUsers.map(u => {
      const store = u.storeId ? getStore(u.storeId) : null;
      const statusClass = u.status === 'active' ? 'ok' : 'out';
      const roleColors = {
        admin: 'background:var(--gradient-danger)',
        manager: 'background:var(--gradient-primary)',
        cashier: 'background:var(--gradient-success)',
        stockkeeper: 'background:var(--warn)'
      };
      return `
        <tr>
          <td><strong>${u.name}</strong></td>
          <td>${u.email}</td>
          <td><span class="badge" style="${roleColors[u.role] || ''}">${u.role || 'N/A'}</span></td>
          <td>${store ? store.name : '-'}</td>
          <td>${u.phone || '-'}</td>
          <td><span class="status ${statusClass}">${u.status || 'active'}</span></td>
          <td class="muted">${u.createdAt || today()}</td>
          <td class="right">
            <button class="btn secondary" data-id="${u.id}" data-action="edit">Edit</button>
            <button class="btn red" data-id="${u.id}" data-action="delete">Delete</button>
          </td>
        </tr>
      `;
    }).join('') || `<tr><td colspan="8" class="muted">No users found. Add your first user above.</td></tr>`;
    
    // Event listeners for edit and delete
    body.querySelectorAll('button[data-action="edit"]').forEach(btn => {
      btn.onclick = () => {
        const userId = btn.dataset.id;
        const user = db.users.find(u => u.id === userId);
        if (user) {
          editingUserId = userId;
          $('#userName').value = user.name || '';
          $('#userEmail').value = user.email || '';
          $('#userPhone').value = user.phone || '';
          $('#userRole').value = user.role || '';
          $('#userStore').value = user.storeId || '';
          $('#userStatus').value = user.status || 'active';
          $('#userPassword').value = '';
          $('#userPassword').placeholder = 'Leave empty to keep current password';
          $('#userAdd').textContent = 'Update User';
          window.scrollTo(0, 0);
        }
      };
    });
    
    body.querySelectorAll('button[data-action="delete"]').forEach(btn => {
      btn.onclick = async () => {
        const userId = btn.dataset.id;
        if (confirm('Are you sure you want to delete this user?')) {
          db.users = db.users.filter(u => u.id !== userId);
          await save();
          fillUsers();
        }
      };
    });
  }
  
  $('#userAdd').onclick = async () => {
    const name = $('#userName').value.trim();
    const email = $('#userEmail').value.trim();
    const phone = $('#userPhone').value.trim();
    const role = $('#userRole').value;
    const storeId = $('#userStore').value;
    const status = $('#userStatus').value;
    const password = $('#userPassword').value;
    
    if (!name || !email || !role) {
      return alert('Name, Email, and Role are required');
    }
    
    if (editingUserId) {
      // Update existing user
      const user = db.users.find(u => u.id === editingUserId);
      if (user) {
        user.name = name;
        user.email = email;
        user.phone = phone;
        user.role = role;
        user.storeId = storeId;
        user.status = status;
        if (password) user.password = password; // In production, this should be hashed
        user.updatedAt = today();
      }
      editingUserId = null;
      $('#userAdd').textContent = 'Save User';
    } else {
      // Create new user
      const newUser = {
        id: uid(),
        name,
        email,
        phone,
        role,
        storeId,
        status,
        password, // In production, this should be hashed
        createdAt: today(),
        updatedAt: today()
      };
      db.users.push(newUser);
    }
    
    await save();
    
    // Clear form
    $('#userName').value = '';
    $('#userEmail').value = '';
    $('#userPhone').value = '';
    $('#userRole').value = '';
    $('#userStore').value = '';
    $('#userStatus').value = 'active';
    $('#userPassword').value = '';
    $('#userPassword').placeholder = 'Password (leave empty to keep current)';
    
    fillUsers();
  };
  
  $('#userRefresh').onclick = fillUsers;
  $('#userSearch').oninput = fillUsers;
  
  fillUsers();
}

/* ====== Settings / Data ====== */
function renderSettings(root){
  root.innerHTML = `
    <div class="stack">
      <div class="card">
        <h3>üí∞ Cash Reconciliation</h3>
        <div class="section">
          <p class="muted" style="margin-bottom:16px;">Record opening and closing cash for daily reconciliation</p>
          <div class="row" style="margin-bottom:16px;">
            <select class="select" id="reconStore">
              <option value="">Select Store</option>
              ${db.stores.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
            </select>
            <input class="input" id="reconDate" type="date" value="${today()}">
          </div>
          <div class="row" style="margin-bottom:16px;">
            <input class="input" id="openingCash" placeholder="Opening Cash" type="number" step="0.01">
            <input class="input" id="closingCash" placeholder="Closing Cash" type="number" step="0.01">
          </div>
          <div class="row">
            <button class="btn green" id="saveRecon">Save Reconciliation</button>
          </div>
        </div>
        <div class="section">
          <h4 style="margin:0 0 12px 0;font-size:14px;">Recent Reconciliations</h4>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Store</th>
                  <th class="right">Opening</th>
                  <th class="right">Cash Sales</th>
                  <th class="right">Closing</th>
                  <th class="right">Variance</th>
                </tr>
              </thead>
              <tbody id="reconBody">
                ${(db.cashReconciliation || []).sort((a,b) => b.date.localeCompare(a.date)).slice(0, 10).map(recon => {
                  const store = getStore(recon.storeId);
                  const variance = recon.closingCash - (recon.openingCash + recon.expectedCash);
                  return `
                    <tr>
                      <td>${recon.date}</td>
                      <td>${store?.name || 'N/A'}</td>
                      <td class="right mono">‚Çπ${money(recon.openingCash)}</td>
                      <td class="right mono">‚Çπ${money(recon.expectedCash)}</td>
                      <td class="right mono">‚Çπ${money(recon.closingCash)}</td>
                      <td class="right mono" style="color:${Math.abs(variance) < 1 ? 'var(--good)' : 'var(--danger)'}">
                        ${variance >= 0 ? '+' : ''}‚Çπ${money(variance)}
                      </td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="6" class="muted">No reconciliation records yet.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>üåê Offline Mode & Sync Status</h3>
        <div class="section stack">
          <div style="background:var(--panel-2);padding:16px;border-radius:8px;margin-bottom:16px;">
            <div class="row" style="align-items:center;margin-bottom:12px;">
              <div>
                <div style="font-weight:bold;margin-bottom:4px;">Connection Status</div>
                <div id="syncStatus" class="muted"></div>
              </div>
              <div id="syncIndicator" style="width:48px;height:48px;border-radius:50%;background:var(--good);"></div>
            </div>
            <div class="row" style="font-size:14px;">
              <div>
                <span class="muted">Pending Changes:</span>
                <strong id="pendingCount" style="margin-left:8px;"></strong>
              </div>
              <div>
                <span class="muted">Last Sync:</span>
                <strong id="lastSync" style="margin-left:8px;"></strong>
              </div>
            </div>
          </div>
          
          <div class="row">
            <button class="btn green" id="btnManualSync">üîÑ Sync Now</button>
            <button class="btn secondary" id="btnClearLocal">Clear Local Cache</button>
          </div>
          
          <div style="background:var(--panel-2);padding:12px;border-radius:8px;margin-top:16px;">
            <h4 style="margin:0 0 8px 0;font-size:14px;">How Offline Mode Works</h4>
            <ul style="margin:0;padding-left:20px;font-size:13px;line-height:1.6;" class="muted">
              <li>All changes are saved locally first (instant)</li>
              <li>When online, data syncs to Firebase automatically</li>
              <li>If offline, changes queue and sync when connection returns</li>
              <li>App works fully offline - no connection required</li>
              <li>Click the status indicator in header for quick sync</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>üñ®Ô∏è Receipt Printer Settings</h3>
        <div class="section stack">
          <div style="background:var(--panel-2);padding:16px;border-radius:8px;margin-bottom:16px;">
            <h4 style="margin:0 0 12px 0;font-size:14px;">Printer Configuration</h4>
            <div class="row" style="margin-bottom:12px;">
              <label style="min-width:120px;">Printer Type:</label>
              <select class="select" id="printerType" style="flex:1;">
                <option value="browser">Browser Print (Standard)</option>
                <option value="thermal">Thermal Printer (58mm)</option>
                <option value="thermal80">Thermal Printer (80mm)</option>
                <option value="escpos">ESC/POS Direct</option>
              </select>
            </div>
            <div class="row" style="margin-bottom:12px;">
              <label style="min-width:120px;">Paper Width:</label>
              <select class="select" id="paperWidth" style="flex:1;">
                <option value="58">58mm (2.28")</option>
                <option value="80" selected>80mm (3.15")</option>
              </select>
            </div>
            <div class="row" style="margin-bottom:12px;">
              <label style="min-width:120px;">Auto Print:</label>
              <input type="checkbox" id="autoPrint" style="width:20px;height:20px;">
              <span class="muted" style="margin-left:8px;">Automatically print after each sale</span>
            </div>
            <div class="row" style="margin-bottom:12px;">
              <label style="min-width:120px;">Receipt Copies:</label>
              <input type="number" class="input" id="receiptCopies" value="1" min="1" max="5" style="width:80px;">
            </div>
          </div>
          
          <div class="row">
            <button class="btn green" id="savePrinterSettings">üíæ Save Printer Settings</button>
            <button class="btn secondary" id="testPrint">üñ®Ô∏è Test Print</button>
          </div>
          
          <div style="background:var(--panel-2);padding:12px;border-radius:8px;margin-top:16px;">
            <h4 style="margin:0 0 8px 0;font-size:14px;">Printer Types</h4>
            <ul style="margin:0;padding-left:20px;font-size:13px;line-height:1.6;" class="muted">
              <li><strong>Browser Print:</strong> Standard printing via browser (works with any printer)</li>
              <li><strong>Thermal 58mm/80mm:</strong> Optimized layout for thermal receipt printers</li>
              <li><strong>ESC/POS Direct:</strong> Direct communication with ESC/POS printers (requires Web Serial API)</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Data & Settings</h3>
        <div class="section stack">
          <div class="row">
            <button class="btn" id="btnDemo">Load Demo Data</button>
            <button class="btn" id="btnBackup">Export Backup</button>
            <input type="file" id="fileImport" style="display:none" accept="application/json">
            <button class="btn" id="btnRestore">Import Backup</button>
            <button class="btn red" id="btnClear">Clear All Data</button>
          </div>
          <div class="muted">For e‚Äëinvoice/e‚Äëway bill integration, push invoices server‚Äëside to NIC via your provider; client-only apps cannot securely hold credentials.</div>
        </div>
      </div>
    </div>
  `;
  
  $('#saveRecon').onclick = async () => {
    const storeId = $('#reconStore').value;
    const date = $('#reconDate').value;
    const openingCash = parseFloat($('#openingCash').value) || 0;
    const closingCash = parseFloat($('#closingCash').value) || 0;
    
    if (!storeId) return alert('Please select a store');
    if (!date) return alert('Please select a date');
    
    // Calculate expected cash from sales
    const salesInvoices = db.invoices.filter(inv => 
      inv.date === date && 
      inv.storeId === storeId && 
      !inv.number?.startsWith('REF-')
    );
    
    let expectedCash = 0;
    salesInvoices.forEach(inv => {
      const payments = Array.isArray(inv.payments) ? inv.payments : [inv.payments];
      payments.forEach(p => {
        if (p.mode === 'Cash') {
          expectedCash += p.amount || 0;
        }
      });
    });
    
    // Check if reconciliation already exists for this date/store
    const existingIndex = db.cashReconciliation.findIndex(r => 
      r.date === date && r.storeId === storeId
    );
    
    const reconciliation = {
      id: existingIndex >= 0 ? db.cashReconciliation[existingIndex].id : uid(),
      date,
      storeId,
      openingCash,
      closingCash,
      expectedCash,
      variance: closingCash - (openingCash + expectedCash),
      recordedBy: currentUser ? currentUser.id : null,
      recordedAt: new Date().toISOString()
    };
    
    if (existingIndex >= 0) {
      db.cashReconciliation[existingIndex] = reconciliation;
    } else {
      db.cashReconciliation.push(reconciliation);
    }
    
    await save();
    alert('Cash reconciliation saved successfully!');
    renderSettings(root);
  };
  
  // Update sync status display
  function updateSyncDisplay() {
    const statusEl = $('#syncStatus');
    const indicatorEl = $('#syncIndicator');
    const pendingEl = $('#pendingCount');
    const lastSyncEl = $('#lastSync');
    
    if (statusEl && indicatorEl && pendingEl && lastSyncEl) {
      if (isOnline) {
        statusEl.textContent = syncQueue.length === 0 ? 'Connected & Synced' : 'Connected - Syncing...';
        indicatorEl.style.background = syncQueue.length === 0 ? 'var(--good)' : 'var(--warn)';
      } else {
        statusEl.textContent = 'Offline - Changes saved locally';
        indicatorEl.style.background = 'var(--danger)';
      }
      
      pendingEl.textContent = syncQueue.length;
      lastSyncEl.textContent = lastSyncTime ? new Date(lastSyncTime).toLocaleString() : 'Never';
    }
  }
  
  updateSyncDisplay();
  
  // Printer settings
  const printerSettings = JSON.parse(localStorage.getItem('printerSettings') || '{"type":"browser","paperWidth":"80","autoPrint":false,"copies":1}');
  $('#printerType').value = printerSettings.type || 'browser';
  $('#paperWidth').value = printerSettings.paperWidth || '80';
  $('#autoPrint').checked = printerSettings.autoPrint || false;
  $('#receiptCopies').value = printerSettings.copies || 1;
  
  $('#savePrinterSettings').onclick = () => {
    const settings = {
      type: $('#printerType').value,
      paperWidth: $('#paperWidth').value,
      autoPrint: $('#autoPrint').checked,
      copies: parseInt($('#receiptCopies').value) || 1
    };
    localStorage.setItem('printerSettings', JSON.stringify(settings));
    showNotification('‚úÖ Printer settings saved', 'success');
  };
  
  $('#testPrint').onclick = () => {
    // Create a test invoice
    const testInvoice = {
      number: 'TEST-001',
      date: today(),
      time: new Date().toLocaleTimeString(),
      storeId: db.stores[0]?.id,
      items: [
        { productId: db.products[0]?.id, size: 'M', color: 'Blue', qty: 2, price: 500, discount: 0, taxPct: 5 },
        { productId: db.products[1]?.id, size: 'L', color: 'Black', qty: 1, price: 1200, discount: 10, taxPct: 12 }
      ],
      totals: { sub: 2080, tax: 124.8, total: 2204.80, round: -0.80 },
      payments: [{ mode: 'Cash', amount: 2204 }],
      notes: 'Test Receipt'
    };
    printInvoice(testInvoice);
  };
  
  // Manual sync button
  $('#btnManualSync').onclick = async () => {
    if (!isOnline) {
      showNotification('Cannot sync while offline', 'warn');
      return;
    }
    
    if (syncQueue.length === 0) {
      showNotification('Everything is already synced!', 'success');
      return;
    }
    
    await syncToFirebase();
    updateSyncDisplay();
  };
  
  // Clear local cache
  $('#btnClearLocal').onclick = () => {
    if (confirm('Clear local cache? This will force a fresh sync from Firebase on next load.')) {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(SYNC_QUEUE_KEY);
      localStorage.removeItem(LAST_SYNC_KEY);
      showNotification('Local cache cleared. Refresh the page.', 'success');
    }
  };
  
  $('#btnDemo').onclick=async ()=>{ loadDemo(); await save(); alert('Demo data loaded'); open('dashboard'); };
  $('#btnBackup').onclick=()=>{
    const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='clothix-backup.json'; a.click();
  };
  $('#btnRestore').onclick=()=> $('#fileImport').click();
  $('#fileImport').onchange=(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=async ()=>{
      try{ db=JSON.parse(r.result); await save(); alert('Imported'); open('dashboard'); }catch(err){ alert('Invalid file'); }
    }; r.readAsText(f);
  };
  $('#btnClear').onclick=async ()=>{ if(confirm('Delete all data?')){
    db=initDB();
    await supabaseClient.from('stores').delete().neq('id', -1);
    await supabaseClient.from('products').delete().neq('id', -1);
    await supabaseClient.from('stock').delete().neq('id', -1);
    await supabaseClient.from('customers').delete().neq('id', -1);
    await supabaseClient.from('invoices').delete().neq('id', -1);
    await supabaseClient.from('transfers').delete().neq('id', -1);
    await supabaseClient.from('purchases').delete().neq('id', -1);
    await supabaseClient.from('seq').delete().neq('id', -1);
    await save();
    open('dashboard');
  } };
}

/* ====== Demo Seed ====== */
function loadDemo(){
  db=initDB();
  const s1={id:uid(),name:'MG Road',code:'BLR-01',address:'Bengaluru',phone:'080-123456'};
  const s2={id:uid(),name:'Phoenix Mall',code:'BLR-02',address:'Bengaluru',phone:'080-654321'};
  db.stores.push(s1,s2);
  const p1={id:uid(),name:'Polo Tee',style:'PT-100',brand:'Clothix',sku:'PT100',barcode:'890100',hsn:'6105',taxPct:5,category:'Men > Tees',mrp:799,price:699,
    sizes:['S','M','L','XL'],colors:['Black','White'],variants:[]};
  p1.sizes.forEach(sz=>p1.colors.forEach(cl=>p1.variants.push({size:sz,color:cl,sku:`PT100-${sz}-${cl.toUpperCase()}`,barcode:`890100${sz[0]}${cl[0]}`})));
  const p2={id:uid(),name:'Denim Jeans',style:'DJ-220',brand:'Clothix',sku:'DJ220',barcode:'890220',hsn:'6203',taxPct:12,category:'Men > Jeans',mrp:1999,price:1699,
    sizes:['30','32','34','36'],colors:['Blue'],variants:[]};
  p2.sizes.forEach(sz=>p2.colors.forEach(cl=>p2.variants.push({size:sz,color:cl,sku:`DJ220-${sz}-${cl.toUpperCase()}`,barcode:`890220${sz}${cl[0]}`})));
  db.products.push(p1,p2);
  // stock
  p1.variants.slice(0,4).forEach(v=>{
    db.stock.push({storeId:s1.id,productId:p1.id,size:v.size,color:v.color,qty:10,min:2});
  });
  p2.variants.forEach(v=>{
    db.stock.push({storeId:s2.id,productId:p2.id,size:v.size,color:v.color,qty:6,min:2});
  });
  // customers
  db.customers.push({id:uid(),name:'Arun',phone:'9876543210',gstin:'',address:'Bengaluru'});
}

/* ====== Header buttons ====== */
$('#exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='clothix-backup.json'; a.click(); };
$('#importBtn').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=async (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async ()=>{ try{ db=JSON.parse(r.result); await save(); alert('Imported'); open('dashboard'); }catch(e){ alert('Invalid file'); } }; r.readAsText(f); }; inp.click(); };
$('#demoBtn').onclick=async ()=>{ loadDemo(); await save(); open('dashboard'); };
$('#resetBtn').onclick=async ()=>{ if(confirm('Clear all data?')){ db=initDB(); await save(); open('dashboard'); } };

auth.onAuthStateChanged(async user => {
  const userControls = $('#user-controls');
  const tabsElement = $('#tabs');
  
  if (user) {
    // User is signed in
    try {
      db = await load();
      
      // Find user in database by email
      currentUser = db.users.find(u => u.email === user.email);
      
      // If user not found in database, assign default admin role for backwards compatibility
      if (!currentUser) {
        currentUser = {
          id: uid(),
          email: user.email,
          role: 'admin',
          name: user.email.split('@')[0],
          status: 'active',
          createdAt: today()
        };
        db.users.push(currentUser);
        await save();
      }
      
      // Render tabs based on user role
      renderTabs();
      if (tabsElement) tabsElement.style.display = 'flex';
      
      if (userControls) {
        userControls.innerHTML = '';
        const userDisplay = document.createElement('span');
        userDisplay.className = 'chip';
        userDisplay.textContent = `${currentUser.name || user.email} (${currentUser.role})`;

        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'btn secondary';
        logoutBtn.textContent = 'Logout';
        logoutBtn.onclick = () => {
          currentUser = null;
          auth.signOut();
        };

        userControls.append(userDisplay, logoutBtn);
      }
      
      // Open default page based on role
      const defaultPage = currentUser.role === 'cashier' ? 'pos' : 
                         currentUser.role === 'stockkeeper' ? 'stock' : 'dashboard';
      open(defaultPage);
    } catch (error) {
      console.error('Error loading data:', error);
      alert('Error loading data. Starting with empty database.');
      db = initDB();
      currentUser = null;
      renderTabs();
      open('dashboard');
    }
  } else {
    // User is signed out
    currentUser = null;
    renderLoginScreen();
    if (tabsElement) tabsElement.style.display = 'none';
  }
});

// Theme toggle
const themeToggle = document.getElementById('theme-toggle');
const htmlEl = document.documentElement;

// Load theme from local storage
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
    htmlEl.setAttribute('data-theme', savedTheme);
    themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
} else {
    // Default to light theme if no preference is saved
    htmlEl.setAttribute('data-theme', 'light');
    themeToggle.textContent = 'üåô';
}

if (themeToggle) {
  themeToggle.addEventListener('click', () => {
      if (htmlEl.getAttribute('data-theme') === 'dark') {
          htmlEl.setAttribute('data-theme', 'light');
          themeToggle.textContent = 'üåô';
          localStorage.setItem('theme', 'light');
      } else {
          htmlEl.setAttribute('data-theme', 'dark');
          themeToggle.textContent = '‚òÄÔ∏è';
          localStorage.setItem('theme', 'dark');
      }
  });
}

}); // End DOMContentLoaded

</script>
</body>
</html>
